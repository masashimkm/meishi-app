<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ååˆºæ›¸ãå‡ºã—å›">
  <link rel="manifest" href="manifest.json">
  <title>ååˆºæ›¸ãå‡ºã—å›</title>

  <style>
    /* ===== ãƒªã‚»ãƒƒãƒˆãƒ»å¤‰æ•° ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    :root {
      --blue:       #1a73e8;
      --blue-dark:  #1557b0;
      --blue-light: #e8f0fe;
      --green:      #1e8e3e;
      --green-bg:   #e6f4ea;
      --red:        #c5221f;
      --red-bg:     #fce8e6;
      --yellow:     #b06000;
      --yellow-bg:  #fef7e0;
      --text:       #202124;
      --sub:        #5f6368;
      --border:     #dadce0;
      --bg:         #f8f9fa;
      --card:       #ffffff;
      --radius:     14px;
    }
    html, body {
      height: 100%; height: 100dvh;
      font-family: -apple-system, 'Hiragino Sans', sans-serif;
      font-size: 17px; color: var(--text);
      background: var(--bg); overflow: hidden;
    }

    /* ===== ç”»é¢ç®¡ç† ===== */
    .screen {
      position: fixed; inset: 0;
      display: none; flex-direction: column;
      overflow-y: auto; -webkit-overflow-scrolling: touch;
    }
    .screen.active { display: flex; }

    /* ===== å…±é€šéƒ¨å“ ===== */
    .btn {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      width: 100%; min-height: 58px; padding: 0 20px;
      border: none; border-radius: var(--radius);
      font-size: 18px; font-weight: 700; cursor: pointer;
      transition: opacity .15s, background .15s;
    }
    .btn:active { opacity: .75; }
    .btn-primary { background: var(--blue); color: #fff; }
    .btn-primary:hover { background: var(--blue-dark); }
    .btn-outline  { background: #fff; color: var(--blue); border: 2.5px solid var(--blue); }
    .btn-green    { background: var(--green); color: #fff; }
    .btn-sm { min-height: 44px; font-size: 15px; }

    .field-label { display: block; font-size: 13px; font-weight: 700; color: var(--sub); margin-bottom: 5px; }
    .text-input {
      width: 100%; padding: 12px 14px; font-size: 17px;
      border: 2px solid var(--border); border-radius: 10px;
      background: #fff; color: var(--text); transition: border-color .15s;
    }
    .text-input:focus { border-color: var(--blue); outline: none; }
    .err-msg { font-size: 14px; color: var(--red); margin-top: 6px; display: none; }
    .err-msg.show { display: block; }
    .hidden { display: none !important; }
    .spinner {
      width: 44px; height: 44px; border: 5px solid var(--border);
      border-top-color: var(--blue); border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===================================================
       S1: ç¤¾å“¡ç•ªå·ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    =================================================== */
    #s-setup {
      background: var(--blue);
      justify-content: center; align-items: center;
    }
    .setup-card {
      background: #fff; border-radius: 20px; padding: 36px 28px;
      width: 100%; max-width: 400px; margin: 20px;
      display: flex; flex-direction: column; gap: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,.2);
    }
    .setup-icon { font-size: 56px; text-align: center; }
    .setup-title { font-size: 22px; font-weight: 800; text-align: center; }
    .setup-sub   { font-size: 15px; color: var(--sub); text-align: center; line-height: 1.6; }
    #emp-input {
      text-align: center; font-size: 32px; font-weight: 800;
      letter-spacing: 14px; padding: 16px;
    }
    .setup-note { font-size: 13px; color: var(--sub); text-align: center; }

    /* ===================================================
       S2: ã‚«ãƒ¡ãƒ©
    =================================================== */
    #s-camera { background: #000; }

    .cam-topbar {
      position: absolute; top: 0; left: 0; right: 0; z-index: 10;
      display: flex; align-items: center; justify-content: space-between;
      padding: 52px 20px 12px;
      background: linear-gradient(to bottom, rgba(0,0,0,.7), transparent);
    }
    .emp-badge {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,.2); backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,.3);
      padding: 6px 14px; border-radius: 20px;
    }
    .emp-badge-label { font-size: 12px; color: rgba(255,255,255,.8); }
    .emp-badge-num   { font-size: 17px; font-weight: 800; color: #fff; letter-spacing: 3px; }
    .cam-change-btn  {
      background: rgba(255,255,255,.2); border: 1px solid rgba(255,255,255,.4);
      color: #fff; padding: 7px 16px; border-radius: 20px;
      font-size: 14px; font-weight: 600; cursor: pointer;
    }

    /* ã‚«ãƒ¡ãƒ©æ˜ åƒ */
    #video-el {
      position: absolute; inset: 0; width: 100%; height: 100%;
      object-fit: cover;
    }

    /* ã‚¬ã‚¤ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .cam-overlay {
      position: absolute; inset: 0; z-index: 5;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      pointer-events: none;
    }
    .guide-wrap { display: flex; flex-direction: column; align-items: center; gap: 14px; }

    .guide-box {
      width: min(85vw, 460px);
      aspect-ratio: 1.75 / 1;   /* ååˆºã®æ¯”ç‡ 91mm:55mm â‰ˆ 1.65 */
      position: relative;
      border: 2px dashed rgba(255,255,255,.6);
      border-radius: 6px;
    }
    /* å››éš…ãƒ–ãƒ©ã‚±ãƒƒãƒˆ */
    .corner {
      position: absolute; width: 22px; height: 22px;
      border-color: #fff; border-style: solid; border-width: 0;
    }
    .corner.tl { top: -2px;  left: -2px;  border-top-width: 3px; border-left-width: 3px;  border-radius: 3px 0 0 0; }
    .corner.tr { top: -2px;  right: -2px; border-top-width: 3px; border-right-width: 3px; border-radius: 0 3px 0 0; }
    .corner.bl { bottom: -2px; left: -2px;  border-bottom-width: 3px; border-left-width: 3px;  border-radius: 0 0 0 3px; }
    .corner.br { bottom: -2px; right: -2px; border-bottom-width: 3px; border-right-width: 3px; border-radius: 0 0 3px 0; }

    .guide-text {
      font-size: 15px; font-weight: 600; color: rgba(255,255,255,.9);
      text-shadow: 0 1px 4px rgba(0,0,0,.6);
    }

    /* ãƒœãƒˆãƒ ãƒãƒ¼ */
    .cam-bottom {
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 10;
      display: flex; flex-direction: column; align-items: center;
      padding: 16px 20px 44px;
      background: linear-gradient(to top, rgba(0,0,0,.7), transparent);
      gap: 16px;
    }
    .cam-tip { font-size: 14px; color: rgba(255,255,255,.8); text-align: center; }

    /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ */
    .shutter-btn {
      width: 76px; height: 76px; border-radius: 50%;
      border: 4px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.15);
      cursor: pointer; position: relative;
      transition: transform .1s;
    }
    .shutter-btn:active { transform: scale(.92); }
    .shutter-inner {
      position: absolute; inset: 6px;
      border-radius: 50%; background: #fff;
    }
    .shutter-btn:disabled .shutter-inner { background: rgba(255,255,255,.4); }

    /* ===================================================
       S3: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ï¼ˆOCRä¸­ / ä¿å­˜ä¸­ï¼‰
    =================================================== */
    #s-progress {
      background: #fff;
      align-items: center; justify-content: center; gap: 24px;
    }
    .progress-text { font-size: 19px; font-weight: 700; }
    .progress-sub  { font-size: 15px; color: var(--sub); }

    /* ===================================================
       S4: ç¢ºèªãƒ»ç·¨é›†
    =================================================== */
    #s-review { background: var(--bg); }

    .review-header {
      background: var(--blue); color: #fff;
      padding: 52px 20px 20px;
    }
    .review-header h1 { font-size: 21px; font-weight: 800; }
    .review-header p  { font-size: 14px; opacity: .85; margin-top: 4px; line-height: 1.5; }

    .review-body { flex: 1; padding: 16px 16px 0; display: flex; flex-direction: column; gap: 12px; }

    .preview-thumb {
      width: 100%; max-height: 140px; object-fit: contain;
      border-radius: 10px; background: #eee;
    }

    .fields-card {
      background: var(--card); border-radius: var(--radius);
      box-shadow: 0 1px 4px rgba(0,0,0,.1);
      overflow: hidden;
    }
    .field-row {
      display: flex; flex-direction: column;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .field-row:last-child { border-bottom: none; }
    .field-row .field-label { margin-bottom: 4px; }
    .field-row .text-input  { font-size: 16px; }
    .field-row.has-val .text-input { border-color: #bbd4fb; background: #f0f6ff; }
    .req-badge {
      display: inline-flex; font-size: 10px; font-weight: 700;
      background: var(--red); color: #fff;
      padding: 1px 5px; border-radius: 3px; margin-left: 4px; vertical-align: middle;
    }

    .memo-card {
      background: var(--card); border-radius: var(--radius);
      padding: 14px 16px; box-shadow: 0 1px 4px rgba(0,0,0,.1);
    }
    textarea.text-input {
      resize: none; font-size: 16px; line-height: 1.6;
    }

    .review-footer {
      padding: 16px; display: flex; flex-direction: column; gap: 10px;
      background: var(--bg);
      border-top: 1px solid var(--border);
    }

    /* ===================================================
       S5: å®Œäº†
    =================================================== */
    #s-result {
      background: var(--card);
      align-items: center; justify-content: center;
    }
    .result-inner {
      display: flex; flex-direction: column; align-items: center;
      gap: 16px; padding: 40px 28px; max-width: 420px; width: 100%;
    }
    .result-icon  { font-size: 80px; line-height: 1; }
    .result-title { font-size: 24px; font-weight: 800; text-align: center; }
    .result-msg   { font-size: 16px; color: var(--sub); text-align: center; line-height: 1.7; white-space: pre-wrap; }
    .result-inner .btn { margin-top: 8px; }

    /* ===================================================
       ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆéè¡¨ç¤ºï¼‰
    =================================================== */
    #work-canvas { display: none; }
  </style>
</head>
<body>

<!-- ===================================================
     S1: ç¤¾å“¡ç•ªå·ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
=================================================== -->
<div id="s-setup" class="screen">
  <div class="setup-card">
    <div class="setup-icon">ğŸªª</div>
    <h1 class="setup-title">ååˆºæ›¸ãå‡ºã—å›</h1>
    <p class="setup-sub">ã‚ãªãŸã®ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>æ¬¡å›ä»¥é™ã¯è‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™</p>

    <div>
      <label class="field-label" for="emp-input">4æ¡ã®ç¤¾å“¡ç•ªå·</label>
      <input id="emp-input" class="text-input" type="text"
        inputmode="numeric" maxlength="4" pattern="\d{4}"
        placeholder="ä¾‹ï¼š0007" autocomplete="off">
      <p id="emp-err" class="err-msg"></p>
    </div>

    <button class="btn btn-primary" onclick="UI.saveEmpId()">
      æ’®å½±ã‚’å§‹ã‚ã‚‹ â†’
    </button>
    <p class="setup-note">â€» å¤‰æ›´ã¯ã‚«ãƒ¡ãƒ©ç”»é¢ã®ã€Œå¤‰æ›´ã€ãƒœã‚¿ãƒ³ã‹ã‚‰</p>
  </div>
</div>

<!-- ===================================================
     S2: ã‚«ãƒ¡ãƒ©
=================================================== -->
<div id="s-camera" class="screen">
  <!-- æ˜ åƒï¼ˆãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼‰ -->
  <video id="video-el" autoplay playsinline muted></video>

  <!-- ä¸Šéƒ¨ãƒãƒ¼ -->
  <div class="cam-topbar">
    <div class="emp-badge">
      <span class="emp-badge-label">ç¤¾å“¡ç•ªå·</span>
      <span id="cam-emp-num" class="emp-badge-num">----</span>
    </div>
    <button class="cam-change-btn" onclick="UI.changeEmpId()">å¤‰æ›´</button>
  </div>

  <!-- ã‚¬ã‚¤ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div class="cam-overlay">
    <div class="guide-wrap">
      <div class="guide-box">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
      </div>
      <p class="guide-text">ååˆºã‚’æ ã®ä¸­ã«å…¥ã‚Œã¦ãã ã•ã„</p>
    </div>
  </div>

  <!-- ä¸‹éƒ¨ãƒãƒ¼ -->
  <div class="cam-bottom">
    <p class="cam-tip">ğŸ’¡ æ˜ã‚‹ã„å ´æ‰€ã§ã€æ‰‹ãƒ–ãƒ¬ãªãæ’®å½±ã—ã¦ãã ã•ã„</p>
    <button id="shutter-btn" class="shutter-btn" disabled onclick="UI.captureAndExtract()">
      <span class="shutter-inner"></span>
    </button>
  </div>
</div>

<!-- ===================================================
     S3: ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹
=================================================== -->
<div id="s-progress" class="screen">
  <div class="spinner"></div>
  <p id="progress-text" class="progress-text">èª­ã¿å–ã‚Šä¸­â€¦</p>
  <p class="progress-sub">ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</p>
</div>

<!-- ===================================================
     S4: ç¢ºèªãƒ»ç·¨é›†
=================================================== -->
<div id="s-review" class="screen">
  <div class="review-header">
    <h1>å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</h1>
    <p>è‡ªå‹•ã§èª­ã¿å–ã‚Šã¾ã—ãŸã€‚é•ã†å ´åˆã¯ã‚¿ãƒƒãƒ—ã—ã¦ä¿®æ­£ã§ãã¾ã™</p>
  </div>

  <div class="review-body">
    <img id="preview-thumb" class="preview-thumb" alt="æ’®å½±ã—ãŸååˆº">

    <div id="fields-card" class="fields-card">
      <!-- JS ã§ç”Ÿæˆ -->
    </div>

    <div class="memo-card">
      <label class="field-label" for="memo-input">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
      <textarea id="memo-input" class="text-input" rows="3"
        placeholder="å±•ç¤ºä¼šã§å–å¾—ã€ç´¹ä»‹ãªã©"></textarea>
    </div>
  </div>

  <div class="review-footer">
    <button class="btn btn-green" onclick="UI.saveCard()">
      âœ… ç™»éŒ²ã™ã‚‹
    </button>
    <button class="btn btn-outline" onclick="UI.retake()">
      ğŸ“· æ’®ã‚Šç›´ã™
    </button>
  </div>
</div>

<!-- ===================================================
     S5: å®Œäº†
=================================================== -->
<div id="s-result" class="screen">
  <div class="result-inner">
    <div id="result-icon"  class="result-icon"></div>
    <h2 id="result-title" class="result-title"></h2>
    <p  id="result-msg"   class="result-msg"></p>
    <button class="btn btn-primary" onclick="UI.nextCapture()">
      ç¶šã‘ã¦æ’®å½±ã™ã‚‹
    </button>
    <button id="retry-btn" class="btn btn-outline btn-sm hidden" onclick="UI.saveCard()">
      å†é€ä¿¡ã™ã‚‹
    </button>
  </div>
</div>

<!-- ä½œæ¥­ç”¨Canvasï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰ -->
<canvas id="work-canvas"></canvas>

<script>
'use strict';

// ================================================================
// âš™ï¸  è¨­å®šï¼ˆã“ã“ã ã‘å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
// ================================================================
const CFG = {
  // GASãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ç™ºè¡Œã•ã‚Œã‚‹URLï¼ˆ/execã§çµ‚ã‚ã‚‹ã‚‚ã®ï¼‰
  GAS_URL:    'https://script.google.com/macros/s/AKfycbyhPuG3_GTScc35YY4FNlrb2t6l_2WJ3j6MQyxgBfa3bJlOdc5dcHN34LQvN_m1q_lb/exec',
  // GASã®CONFIG.API_SECRETã¨åŒã˜å€¤
  API_SECRET: 'welzowelzowelzo',
};

// ================================================================
// ğŸ“‹  ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ï¼ˆãƒ©ãƒ™ãƒ«ãƒ»å¿…é ˆã‚’ç®¡ç†ï¼‰
// ================================================================
const FIELDS = [
  { key: 'companyName',  label: 'ä¼šç¤¾å',          req: true  },
  { key: 'department',   label: 'éƒ¨ç½²å',          req: false },
  { key: 'position',     label: 'å½¹è·',            req: false },
  { key: 'fullName',     label: 'æ°å',            req: true  },
  { key: 'furigana',     label: 'ãƒ•ãƒªã‚¬ãƒŠ',        req: false },
  { key: 'officePhone',  label: 'é›»è©±ï¼ˆã‚ªãƒ•ã‚£ã‚¹ï¼‰', req: false },
  { key: 'mobilePhone',  label: 'æºå¸¯é›»è©±ç•ªå·',    req: false },
  { key: 'fax',          label: 'FAX',             req: false },
  { key: 'email',        label: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',  req: false },
  { key: 'postalCode',   label: 'éƒµä¾¿ç•ªå·',        req: false },
  { key: 'address',      label: 'ä½æ‰€',            req: false },
  { key: 'website',      label: 'Webã‚µã‚¤ãƒˆURL',    req: false },
];

// ================================================================
// çŠ¶æ…‹ç®¡ç†
// ================================================================
const ST = {
  empId:  '',    // ç¤¾å“¡ç•ªå·
  base64: null,  // æ’®å½±ç”»åƒ
  reqId:  '',    // è¦æ±‚IDï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
  ts:     '',    // æ’®å½±æ—¥æ™‚
};
let camStream = null;

// ================================================================
// åˆæœŸåŒ–
// ================================================================
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('meishi_emp');
  if (saved && /^\d{4}$/.test(saved)) {
    ST.empId = saved;
    _refreshEmpBadge();
    Camera.open();
  } else {
    Screen.show('s-setup');
  }
});

// ================================================================
// ç”»é¢ç®¡ç†
// ================================================================
const Screen = {
  show(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
  },
};

// ================================================================
// UI ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
// ================================================================
const UI = {

  // â”€â”€ S1: ç¤¾å“¡ç•ªå·ç™»éŒ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saveEmpId() {
    const val = document.getElementById('emp-input').value.trim();
    const err = document.getElementById('emp-err');
    if (!/^\d{4}$/.test(val)) {
      err.textContent = 'âŒ 0ã€œ9ã®4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š0007ï¼‰';
      err.classList.add('show');
      return;
    }
    err.classList.remove('show');
    ST.empId = val;
    localStorage.setItem('meishi_emp', val);
    _refreshEmpBadge();
    Camera.open();
  },

  // â”€â”€ S2: ã‚«ãƒ¡ãƒ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changeEmpId() {
    Camera.stop();
    document.getElementById('emp-input').value = ST.empId;
    Screen.show('s-setup');
  },

  async captureAndExtract() {
    // æ’®å½±
    const imageData = Camera.capture();
    if (!imageData) return;
    Camera.stop();

    // æ—¥æ™‚ãƒ»è¦æ±‚IDç”Ÿæˆ
    ST.ts    = new Date().toISOString();
    ST.reqId = ST.empId + '_' + ST.ts.replace(/\D/g, '').slice(0, 14);

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚»ãƒƒãƒˆ
    document.getElementById('preview-thumb').src = 'data:image/jpeg;base64,' + imageData;
    ST.base64 = imageData;

    // OCR
    _setProgress('ååˆºã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦');
    Screen.show('s-progress');

    let extracted = {};
    try {
      const res = await Api.post({
        action: 'extract', imageBase64: ST.base64,
        employeeId: ST.empId, timestamp: ST.ts,
      });
      if (res.ok) extracted = res.extracted || {};
      // OCRå¤±æ•—ã§ã‚‚ç©ºãƒ•ã‚©ãƒ¼ãƒ ã§ç¶šè¡Œï¼ˆæ‰‹å‹•å…¥åŠ›å¯ï¼‰
    } catch (_) { /* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç­‰ã‚¨ãƒ©ãƒ¼ â†’ ç©ºãƒ•ã‚©ãƒ¼ãƒ ã§ç¶šè¡Œ */ }

    Review.build(extracted);
    Screen.show('s-review');
  },

  // â”€â”€ S4: ç¢ºèªãƒ»ç™»éŒ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async saveCard() {
    const data = Review.getData();
    const memo = document.getElementById('memo-input').value;

    _setProgress('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç™»éŒ²ä¸­â€¦');
    Screen.show('s-progress');

    try {
      const res = await Api.post({
        action: 'save', data,
        employeeId: ST.empId, timestamp: ST.ts,
        requestId: ST.reqId, memo,
      });

      if (res.status === 'DUPLICATE') {
        _showResult('info', 'ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™', 'ã“ã®ååˆºã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™\nï¼ˆé‡è¤‡é€ä¿¡ã‚’é˜²æ­¢ã—ã¾ã—ãŸï¼‰');
        return;
      }
      if (!res.ok) throw new Error(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');

      const type = res.status === 'SUCCESS' ? 'success' : 'warn';
      _showResult(type, res.status === 'SUCCESS' ? 'ç™»éŒ²å®Œäº†ï¼' : 'è¦ç¢ºèªã§ä¿å­˜ã—ã¾ã—ãŸ', res.message || '');
    } catch (err) {
      _showResult('error', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ',
        err.message + '\n\nã€Œå†é€ä¿¡ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„', true);
    }
  },

  retake()      { Camera.open(); },
  nextCapture() { Camera.open(); },
};

// ================================================================
// ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
// ================================================================
const Camera = {
  async open() {
    Screen.show('s-camera');
    _refreshEmpBadge();
    await this.start();
  },

  async start() {
    try {
      if (camStream) this.stop();
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 } },
        audio: false,
      });
      const video = document.getElementById('video-el');
      video.srcObject = camStream;
      video.onloadedmetadata = () => {
        document.getElementById('shutter-btn').disabled = false;
      };
    } catch (err) {
      const msg = err.name === 'NotAllowedError'
        ? 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\niPhone ã®ã€Œè¨­å®šã€â†’ã€ŒSafariã€â†’ã€Œã‚«ãƒ¡ãƒ©ã€\nã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„\nï¼ˆã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: E015ï¼‰'
        : 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„\nï¼ˆã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: E016ï¼‰';
      _showResult('error', 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', msg);
    }
  },

  stop() {
    if (camStream) {
      camStream.getTracks().forEach(t => t.stop());
      camStream = null;
    }
    document.getElementById('shutter-btn').disabled = true;
  },

  capture() {
    const video  = document.getElementById('video-el');
    const canvas = document.getElementById('work-canvas');
    if (!video.videoWidth) return null;

    // æœ€å¤§1200pxå¹…ã«ãƒªã‚µã‚¤ã‚ºï¼ˆå®¹é‡å‰Šæ¸›ï¼‰
    const MAX = 1200;
    const r   = Math.min(1, MAX / video.videoWidth);
    canvas.width  = Math.round(video.videoWidth  * r);
    canvas.height = Math.round(video.videoHeight * r);
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    // Base64å–å¾—ï¼ˆå†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯æ›¸ãè¾¼ã¾ãªã„ï¼‰
    return canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
  },
};

// ================================================================
// ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ 
// ================================================================
const Review = {
  build(data) {
    const card = document.getElementById('fields-card');
    card.innerHTML = FIELDS.map(f => {
      const val  = (data[f.key] || '').replace(/"/g, '&quot;');
      const hasV = !!val;
      const req  = f.req ? '<span class="req-badge">å¿…é ˆ</span>' : '';
      return `
        <div class="field-row${hasV ? ' has-val' : ''}">
          <label class="field-label" for="f-${f.key}">${f.label}${req}</label>
          <input id="f-${f.key}" class="text-input" type="text"
            value="${val}" placeholder="ï¼ˆç©ºæ¬„ã§ã‚‚ç™»éŒ²ã§ãã¾ã™ï¼‰">
        </div>`;
    }).join('');
    document.getElementById('memo-input').value = '';
  },

  getData() {
    const out = {};
    FIELDS.forEach(f => {
      out[f.key] = (document.getElementById('f-' + f.key) || {}).value || '';
    });
    return out;
  },
};

// ================================================================
// APIé€šä¿¡
// ================================================================
const Api = {
  async post(data) {
    const res = await fetch(CFG.GAS_URL, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ ...data, secret: CFG.API_SECRET }),
    });
    if (!res.ok) throw new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆHTTP ' + res.status + 'ï¼‰ï¼ˆE060ï¼‰');
    return res.json();
  },
};

// ================================================================
// å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
// ================================================================
function _refreshEmpBadge() {
  const el = document.getElementById('cam-emp-num');
  if (el) el.textContent = ST.empId || '----';
}

function _setProgress(text) {
  const el = document.getElementById('progress-text');
  if (el) el.textContent = text;
}

function _showResult(type, title, msg, showRetry = false) {
  const icons = { success: 'âœ…', warn: 'âš ï¸', error: 'âŒ', info: 'â„¹ï¸' };
  document.getElementById('result-icon').textContent  = icons[type] || 'â“';
  document.getElementById('result-title').textContent = title;
  document.getElementById('result-msg').textContent   = msg;
  const rb = document.getElementById('retry-btn');
  showRetry ? rb.classList.remove('hidden') : rb.classList.add('hidden');
  Screen.show('s-result');
}
</script>
</body>
</html>
