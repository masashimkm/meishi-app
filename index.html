<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <!-- v2.5: PWAæ©Ÿèƒ½å‰Šé™¤ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å°‚ç”¨ï¼‰ã€‚ã‚¢ãƒ—ãƒªæ©Ÿèƒ½ï¼ˆmanifest/apple-mobile-web-appï¼‰ä¸è¦ -->
  <title>ååˆºæ›¸ãå‡ºã—å›</title>
  <style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
:root{
  --blue:#1a73e8;--blue-dk:#1557b0;--blue-lt:#e8f0fe;
  --green:#1e8e3e;--green-bg:#e6f4ea;
  --red:#c5221f;--red-bg:#fce8e6;
  --warn:#b06000;--warn-bg:#fef7e0;
  --purple:#6264a7;
  --text:#202124;--sub:#5f6368;--border:#dadce0;--bg:#f8f9fa;
  --radius:14px;
  --font-body:18px;--font-label:15px;--font-small:14px;
}
html,body{height:100%;height:100dvh;font-family:-apple-system,'Hiragino Sans',sans-serif;
  font-size:var(--font-body);color:var(--text);background:var(--bg);
  overflow:hidden;overflow-x:hidden}

/* â”€â”€ ç”»é¢ç®¡ç† â”€â”€ */
.screen{position:fixed;inset:0;display:none;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch}
.screen.active{display:flex}

/* â”€â”€ å…±é€šãƒœã‚¿ãƒ³ â”€â”€ */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;
  width:100%;min-height:62px;padding:0 20px;border:none;border-radius:var(--radius);
  font-size:19px;font-weight:700;cursor:pointer;transition:opacity .15s;line-height:1.4}
.btn:active{opacity:.75}
.btn-blue  {background:var(--blue);color:#fff}
.btn-green {background:var(--green);color:#fff}
.btn-outline{background:#fff;color:var(--blue);border:2.5px solid var(--blue)}
.btn-gray  {background:#e8eaed;color:var(--text)}
.btn-orange{background:#e65c00;color:#fff}
.btn-purple{background:var(--purple);color:#fff}
.btn-sm    {min-height:50px;font-size:16px}

/* â”€â”€ å…±é€šãƒ•ã‚©ãƒ¼ãƒ  â”€â”€ */
.lbl{display:block;font-size:var(--font-label);font-weight:700;color:var(--sub);margin-bottom:6px}
.inp{width:100%;padding:15px 14px;font-size:17px;border:2px solid var(--border);
  border-radius:10px;background:#fff;color:var(--text);transition:border-color .15s;-webkit-appearance:none}
.inp:focus{border-color:var(--blue);outline:none}
.inp-wrap{position:relative}
.inp-wrap .inp{padding-right:48px}
.eye-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);
  background:none;border:none;font-size:20px;cursor:pointer}
.err{font-size:var(--font-small);color:var(--red);margin-top:6px;display:none}
.err.show{display:block}

/* â”€â”€ ãƒãƒŠãƒ¼ â”€â”€ */
.banner{padding:16px;border-radius:10px;font-size:var(--font-label);font-weight:600;
  line-height:1.6;white-space:pre-wrap;display:none}
.banner.show{display:block}
.banner.err {background:var(--red-bg);color:var(--red)}
.banner.warn{background:var(--warn-bg);color:var(--warn)}
.banner.ok  {background:var(--green-bg);color:var(--green)}
.banner.info{background:var(--blue-lt);color:var(--blue-dk)}

/* â”€â”€ ã‚¹ãƒ”ãƒŠãƒ¼ â”€â”€ */
.spinner{width:44px;height:44px;border:5px solid var(--border);
  border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â•â•â•â• S0: æ¥ç¶šè¨­å®š â•â•â•â• */
#s-cfg{background:var(--blue);align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.cfg-card{background:#fff;border-radius:20px;padding:28px 24px;
  width:100%;max-width:420px;display:flex;flex-direction:column;gap:18px;
  box-shadow:0 8px 32px rgba(0,0,0,.2)}
.cfg-title{font-size:22px;font-weight:800;text-align:center}
.cfg-sub  {font-size:15px;color:var(--sub);text-align:center;line-height:1.6}
.cfg-field{display:flex;flex-direction:column;gap:6px}
.cfg-hint {font-size:13px;color:var(--sub);line-height:1.6;margin-top:4px}
.cfg-hint b{color:var(--blue)}
.cfg-divider{border:none;border-top:1px solid var(--border)}

/* â•â•â•â• S1: ç¤¾å“¡ç•ªå· â•â•â•â• */
#s-emp{background:var(--blue);align-items:center;justify-content:center;padding:20px}
.emp-card{background:#fff;border-radius:20px;padding:32px 24px;
  width:100%;max-width:420px;display:flex;flex-direction:column;gap:20px;
  box-shadow:0 8px 32px rgba(0,0,0,.2)}
.emp-icon {font-size:56px;text-align:center}
.emp-title{font-size:23px;font-weight:800;text-align:center}
.emp-sub  {font-size:16px;color:var(--sub);text-align:center;line-height:1.7}
#inp-emp  {text-align:center;font-size:36px;font-weight:800;letter-spacing:14px}
.emp-note {font-size:var(--font-small);color:var(--sub);text-align:center}

/* â•â•â•â• S2: ã‚«ãƒ¡ãƒ© â•â•â•â• */
#s-cam{background:#000;overflow:hidden}
#video-el{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none}

/* ã‚«ãƒ¡ãƒ©ä¸Šéƒ¨ï¼ˆ2æ®µãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ */
.cam-top{
  position:absolute;top:0;left:0;right:0;z-index:10;
  display:flex;flex-direction:column;gap:8px;
  padding:12px 14px 10px;
  padding-top:max(12px,env(safe-area-inset-top,12px));
  background:linear-gradient(to bottom,rgba(0,0,0,.78),transparent)}
.cam-row{display:flex;align-items:center;justify-content:space-between;gap:8px}

/* ç¤¾å“¡ç•ªå·ãƒãƒƒã‚¸ */
.emp-badge{display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.18);backdrop-filter:blur(4px);
  border:1.5px solid rgba(255,255,255,.4);padding:8px 14px;border-radius:22px;
  cursor:pointer;-webkit-appearance:none;flex-shrink:0}
.badge-lbl{font-size:11px;color:rgba(255,255,255,.9);white-space:nowrap}
.badge-num{font-size:18px;font-weight:800;color:#fff;letter-spacing:3px}
.badge-edit{font-size:12px;color:rgba(255,255,255,.7);margin-left:2px}
.cam-company-lbl{font-size:11px;color:rgba(255,255,255,.75);
  text-shadow:0 1px 3px rgba(0,0,0,.7);padding-left:2px;
  max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:none}

.cam-top-btn{background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.35);
  color:#fff;padding:8px 14px;border-radius:20px;font-size:13px;font-weight:700;
  cursor:pointer;white-space:nowrap;-webkit-appearance:none}
.cam-top-btn.active{background:rgba(255,220,100,.55)}

/* ã‚«ãƒ¡ãƒ©ã‚¬ã‚¤ãƒ‰ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚’æ å†…ã«é…ç½®ï¼‰ */
.cam-overlay{
  position:absolute;inset:0;z-index:5;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  pointer-events:none;
  padding-top:115px;padding-bottom:155px}
.guide-box{
  position:relative;border:2px dashed rgba(255,255,255,.65);border-radius:6px;
  transition:all .3s;display:flex;align-items:center;justify-content:center}
.guide-box.landscape{width:min(84vw,440px);aspect-ratio:1.75}
.guide-box.portrait {width:min(48vw,230px);aspect-ratio:0.58}
.cor{position:absolute;width:22px;height:22px;border-color:#fff;border-style:solid;border-width:0}
.cor.tl{top:-2px;left:-2px;border-top-width:3px;border-left-width:3px;border-radius:3px 0 0 0}
.cor.tr{top:-2px;right:-2px;border-top-width:3px;border-right-width:3px;border-radius:0 3px 0 0}
.cor.bl{bottom:-2px;left:-2px;border-bottom-width:3px;border-left-width:3px;border-radius:0 0 0 3px}
.cor.br{bottom:-2px;right:-2px;border-bottom-width:3px;border-right-width:3px;border-radius:0 0 3px 0}
/* æ å†…ãƒ†ã‚­ã‚¹ãƒˆ */
.guide-inner-txt{
  font-size:15px;font-weight:700;color:rgba(255,255,255,.9);
  text-shadow:0 1px 4px rgba(0,0,0,.8);text-align:center;
  pointer-events:none;padding:0 12px;line-height:1.5}

/* æ’®å½±ãƒœã‚¿ãƒ³ï¼ˆæ ã¨é‡ãªã‚‰ãªã„ä¸‹éƒ¨å›ºå®šï¼‰ */
.cam-bot{
  position:absolute;bottom:0;left:0;right:0;z-index:10;
  display:flex;flex-direction:column;align-items:center;
  padding:16px 20px max(34px,env(safe-area-inset-bottom,34px));
  background:linear-gradient(to top,rgba(0,0,0,.75),transparent)}
.shutter{width:78px;height:78px;border-radius:50%;
  border:4px solid rgba(255,255,255,.9);background:rgba(255,255,255,.15);
  cursor:pointer;position:relative;transition:transform .1s;flex-shrink:0}
.shutter:active{transform:scale(.92)}
.shutter-dot{position:absolute;inset:6px;border-radius:50%;background:#fff;transition:background .15s}
.shutter:disabled .shutter-dot{background:rgba(255,255,255,.35)}

/* è£é¢æ’®å½±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
#back-overlay{position:absolute;inset:0;z-index:20;background:rgba(0,0,0,.8);
  display:none;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:28px}
#back-overlay.show{display:flex}
.back-msg{color:#fff;font-size:20px;font-weight:700;text-align:center;line-height:1.7}
.back-btns{display:flex;flex-direction:column;gap:12px;width:100%;max-width:320px}

/* â•â•â•â• S3: å‡¦ç†ä¸­ â•â•â•â• */
#s-prog{background:#fff;align-items:center;justify-content:center;gap:22px}
.prog-txt{font-size:20px;font-weight:700;text-align:center}
.prog-sub{font-size:16px;color:var(--sub)}

/* â•â•â•â• S4: ç¢ºèªãƒ»ç·¨é›† â•â•â•â• */
#s-rev{background:var(--bg)}
.rev-head{background:var(--blue);color:#fff;
  padding:max(env(safe-area-inset-top,14px),14px) 16px 12px;
  display:flex;align-items:center;gap:10px}
.rev-back-btn{background:none;border:1.5px solid rgba(255,255,255,.65);color:#fff;
  padding:7px 13px;border-radius:18px;font-size:13px;font-weight:700;
  cursor:pointer;white-space:nowrap;flex-shrink:0;-webkit-appearance:none}
.rev-head h1{font-size:15px;font-weight:800;flex:1;line-height:1.4}
.rev-body{flex:1;padding:14px 14px 0;display:flex;flex-direction:column;gap:14px}
.thumb-row{display:flex;gap:8px}
.thumb{flex:1;max-height:110px;object-fit:contain;border-radius:10px;background:#eee}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.section-card{background:#fff;border-radius:var(--radius);box-shadow:0 1px 4px rgba(0,0,0,.1);overflow:hidden}
.section-hd{padding:12px 16px;background:var(--blue-lt);border-bottom:1px solid #c5d8f7;
  font-size:var(--font-label);font-weight:800;color:var(--blue-dk)}
.f-row{display:flex;flex-direction:column;
  padding:10px 16px;border-bottom:1px solid var(--border)}
.f-row:last-child{border-bottom:none}
.f-row.filled .inp{border-color:#aacbff;background:#f0f6ff}
.f-row .lbl-icon{font-size:16px;margin-right:4px}
.req{display:inline-flex;font-size:11px;font-weight:700;
  background:var(--red);color:#fff;padding:2px 6px;border-radius:3px;margin-left:5px}
/* f-input-wrap: input + âœ• ã‚’æ¨ªä¸¦ã³ï¼ˆâœ•ã¯inputæ å†…å³å´ã«çµ¶å¯¾é…ç½®ï¼‰ */
.f-input-wrap{position:relative;display:flex;align-items:center}
.f-input-wrap .inp{padding-right:42px}
/* âœ• ãƒœã‚¿ãƒ³ï¼ˆinputæ å†…ã®å³ç«¯ã«é…ç½®ãƒ»ã‚„ã‚„å°ã•ã‚ï¼‰ */
.f-clear-btn{
  position:absolute;right:8px;top:50%;transform:translateY(-50%);
  width:26px;height:26px;border:none;border-radius:50%;
  background:#e8eaed;color:var(--sub);font-size:12px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:background .12s}
.f-clear-btn:hover{background:#dadce0;color:var(--red)}
/* éƒµä¾¿ç•ªå·ãƒ’ãƒ³ãƒˆ */
.postal-hint{font-size:12px;color:var(--blue);margin-top:3px;display:none}
.postal-hint.show{display:block}

/* å…¬é–‹è¨­å®š */
.vis-group{display:flex;gap:10px;margin-top:8px}
.vis-btn{flex:1;padding:14px 8px;border:2.5px solid var(--border);border-radius:10px;
  background:#fff;cursor:pointer;text-align:center;transition:all .15s}
.vis-btn.active.public {border-color:var(--green);background:var(--green-bg)}
.vis-btn.active.private{border-color:var(--blue);background:var(--blue-lt)}
.vis-icon{font-size:22px;display:block;margin-bottom:4px}
.vis-label{font-size:14px;font-weight:700;display:block}
.vis-desc{font-size:12px;color:var(--sub);display:block;margin-top:2px}

.memo-card{background:#fff;border-radius:var(--radius);padding:16px;box-shadow:0 1px 4px rgba(0,0,0,.1)}
textarea.inp{resize:none;line-height:1.7}
.rev-foot{padding:14px;display:flex;flex-direction:column;gap:10px;
  border-top:1px solid var(--border);background:var(--bg)}

/* é‡è¤‡è­¦å‘Š */
.dup-banner{background:#fff8e1;border:2px solid #ffb300;border-radius:10px;
  padding:14px 16px;font-size:var(--font-label);line-height:1.7;display:none}
.dup-banner.show{display:block}
.dup-banner strong{color:#e65100}

/* â•â•â•â• S5: å®Œäº† â•â•â•â• */
#s-done{background:#fff;overflow-y:auto}
.done-inner{display:flex;flex-direction:column;align-items:center;
  gap:14px;padding:36px 24px;max-width:420px;width:100%;margin:0 auto}
.done-title{font-size:26px;font-weight:800;text-align:center;margin-top:8px}
.done-msg  {font-size:17px;color:var(--sub);text-align:center;line-height:1.7;white-space:pre-wrap}
.session-info{font-size:var(--font-small);color:var(--sub);text-align:center}
.done-inner .btn{margin-top:4px}

/* é€ä¿¡ã‚«ãƒ¼ãƒ‰ */
.send-card{background:#f0f6ff;border:2px solid #aacbff;border-radius:var(--radius);
  padding:16px;width:100%;margin-top:4px}
.send-ttl{font-size:var(--font-label);font-weight:800;color:var(--blue-dk);margin-bottom:12px}
.send-row{display:flex;gap:8px;align-items:stretch}
.send-sel{flex:1;padding:12px;font-size:15px;border:2px solid var(--border);
  border-radius:8px;background:#fff;-webkit-appearance:none;min-height:50px}
.btn-mail{padding:12px 16px;background:var(--blue);color:#fff;border:none;
  border-radius:8px;font-size:20px;cursor:pointer;min-height:50px;display:flex;align-items:center}
.btn-link-sm{background:none;border:none;color:var(--blue);font-size:var(--font-small);
  font-weight:700;cursor:pointer;padding:8px 0;display:block;text-align:left}
.send-email-box{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.btn-add-email{padding:11px 16px;background:var(--green);color:#fff;border:none;
  border-radius:8px;font-size:var(--font-label);font-weight:700;cursor:pointer;white-space:nowrap}
.send-div{height:1px;background:#aacbff;margin:12px 0}
.btn-teams{width:100%;padding:15px;background:var(--purple);color:#fff;border:none;
  border-radius:8px;font-size:17px;font-weight:700;cursor:pointer;min-height:56px;
  display:flex;align-items:center;justify-content:center;gap:8px}

/* â•â•â•â• S6: é€ä¿¡å±¥æ­´ â•â•â•â• */
#s-hist{background:var(--bg)}
.hist-head{background:var(--blue);color:#fff;padding:52px 18px 14px;
  display:flex;align-items:center;gap:12px}
.hist-head h1{font-size:20px;font-weight:800;flex:1}
.hist-back{background:none;border:1.5px solid rgba(255,255,255,.6);color:#fff;
  padding:8px 16px;border-radius:18px;font-size:var(--font-small);font-weight:700;cursor:pointer}

.hist-body{flex:1;padding:14px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;padding-bottom:80px}
.hist-empty{text-align:center;color:var(--sub);padding:60px 20px;font-size:17px;line-height:1.8}

/* å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»˜ãï¼‰ */
.hist-item{background:#fff;border-radius:var(--radius);padding:14px 16px;
  box-shadow:0 1px 4px rgba(0,0,0,.1);border-left:4px solid var(--blue);
  display:flex;gap:12px;align-items:flex-start;cursor:pointer;transition:background .15s}
.hist-item:active{background:#f0f6ff}
.hist-item.teams{border-left-color:var(--purple)}
.hist-item.selected{background:#e8f0fe}
.hist-check{width:22px;height:22px;border:2px solid var(--border);border-radius:4px;
  display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;
  cursor:pointer;background:#fff;transition:all .15s}
.hist-check.on{background:var(--blue);border-color:var(--blue);color:#fff}
.hist-info{flex:1;min-width:0}
.hist-type{display:inline-flex;align-items:center;gap:4px;font-size:12px;font-weight:700;
  padding:2px 8px;border-radius:10px;margin-bottom:6px}
.hist-type.email{background:#e8f0fe;color:var(--blue)}
.hist-type.teams{background:#ede9f7;color:var(--purple)}
.hist-company{font-size:17px;font-weight:800;color:var(--text)}
.hist-person{font-size:var(--font-label);color:var(--text);margin-top:3px}
.hist-affil{font-size:var(--font-small);color:var(--sub);margin-top:2px}
.hist-time{font-size:12px;color:var(--sub);margin-top:5px}
.hist-recip{font-size:12px;color:var(--sub)}
.hist-clear-btn{background:none;border:none;color:var(--red);font-size:var(--font-small);
  font-weight:600;cursor:pointer;padding:8px;text-align:center;width:100%}

/* ä¸€æ‹¬æ“ä½œãƒãƒ¼ï¼ˆè¤‡æ•°é¸æŠæ™‚ï¼‰ */
.hist-batch-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:50;
  background:#fff;border-top:2px solid var(--blue);padding:12px 16px;
  display:none;flex-direction:column;gap:10px;
  box-shadow:0 -4px 16px rgba(0,0,0,.12)}
.hist-batch-bar.show{display:flex}
.hist-batch-info{font-size:var(--font-small);font-weight:700;color:var(--blue);text-align:center}
.hist-batch-btns{display:flex;gap:10px}
.hist-batch-btns .btn{flex:1;min-height:54px;font-size:16px}

/* å±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay{
  position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.5);
  display:none;align-items:flex-end;justify-content:center}
.modal-overlay.show{display:flex}
.modal-card{
  background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:520px;
  max-height:90vh;display:flex;flex-direction:column;overflow:hidden}
.modal-head{background:var(--blue);color:#fff;padding:20px 18px 16px;
  display:flex;align-items:center;gap:12px;flex-shrink:0}
.modal-head h2{font-size:18px;font-weight:800;flex:1}
.modal-close{background:none;border:1.5px solid rgba(255,255,255,.6);color:#fff;
  padding:8px 16px;border-radius:18px;font-size:var(--font-small);font-weight:700;cursor:pointer}
.modal-body{flex:1;overflow-y:auto;padding:16px}
.modal-foot{padding:14px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:10px}
.modal-field-row{display:flex;flex-direction:column;gap:4px;padding:10px 0;border-bottom:1px solid var(--border)}
.modal-field-row:last-child{border-bottom:none}
.modal-lbl{font-size:13px;font-weight:700;color:var(--sub)}
.modal-val{font-size:16px;color:var(--text);word-break:break-all}
.modal-inp{width:100%;padding:11px 12px;font-size:16px;border:2px solid var(--border);
  border-radius:8px;background:#fff;-webkit-appearance:none}
.modal-inp:focus{border-color:var(--blue);outline:none}
.modal-edit-toggle{background:none;border:none;color:var(--blue);font-size:var(--font-small);
  font-weight:700;cursor:pointer;padding:4px 0;text-align:right;width:100%}

#work-canvas{display:none}

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
#_toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.78);color:#fff;padding:12px 22px;border-radius:22px;
  font-size:15px;font-weight:600;z-index:9999;max-width:85vw;text-align:center;
  line-height:1.5;transition:opacity .3s;opacity:0;pointer-events:none}
</style>
</head>
<body>

<!-- â•â• S0: æ¥ç¶šè¨­å®š â•â• -->
<div id="s-cfg" class="screen">
  <div class="cfg-card">
    <div style="font-size:52px;text-align:center">ğŸªª</div>
    <h1 class="cfg-title">ååˆºæ›¸ãå‡ºã—å›</h1>
    <p class="cfg-sub">GASã®URLã¨åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>å­ä¼šç¤¾ãƒ»ä»–ç¤¾ã”ã¨ã«ç•°ãªã‚‹URLã‚’è¨­å®šã§ãã¾ã™</p>

    <div class="cfg-field">
      <label class="lbl">ğŸ”— GASã®URL</label>
      <input id="cfg-url" class="inp" type="url" placeholder="https://script.google.com/macros/s/â€¦/exec" autocomplete="off">
      <p class="cfg-hint"><b>ç¢ºèªæ–¹æ³•ï¼š</b>GASã‚¨ãƒ‡ã‚£ã‚¿ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç† â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã®URLï¼ˆ<b>/exec</b>ã§çµ‚ã‚ã‚‹ã‚‚ã®ï¼‰</p>
    </div>

    <div class="cfg-field">
      <label class="lbl">ğŸ”‘ åˆè¨€è‘‰ï¼ˆAPIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰</label>
      <div class="inp-wrap">
        <input id="cfg-secret" class="inp" type="password" placeholder="GASã«è¨­å®šã—ãŸåˆè¨€è‘‰" autocomplete="new-password">
        <button class="eye-btn" onclick="toggleEye('cfg-secret',this)">ğŸ‘</button>
      </div>
    </div>

    <div class="cfg-field">
      <label class="lbl">ğŸ“§ é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆæœ€å¤§5ä»¶ï¼‰</label>
      <div id="cfg-email-list"></div>
      <button class="btn btn-gray btn-sm" style="margin-top:8px" onclick="Cfg.toggleEmailBox()">ï¼‹ ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ </button>
      <div id="cfg-email-box" style="display:none;margin-top:8px;display:flex;flex-direction:column;gap:6px">
        <input id="cfg-email-inp" type="email" class="inp" placeholder="ä¾‹ï¼štanaka@company.co.jp" style="font-size:16px">
        <button class="btn btn-green btn-sm" onclick="Cfg.addEmail()">è¿½åŠ </button>
      </div>
    </div>

    <div id="cfg-banner" class="banner"></div>
    <button class="btn btn-gray btn-sm" onclick="Cfg.test()">ğŸ”— æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰</button>
    <hr class="cfg-divider">
    <button class="btn btn-blue" onclick="Cfg.save()">è¨­å®šã‚’ä¿å­˜ã—ã¦å§‹ã‚ã‚‹ â†’</button>
  </div>
</div>

<!-- â•â• S1: ç¤¾å“¡ç•ªå· â•â• -->
<div id="s-emp" class="screen">
  <div class="emp-card">
    <div class="emp-icon">ğŸ‘¤</div>
    <h1 class="emp-title">ç¤¾å“¡ç•ªå·ã®ç™»éŒ²</h1>
    <p class="emp-sub">ã‚ãªãŸã®4æ¡ã®ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>æ¬¡å›ä»¥é™ã¯è‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™</p>
    <div>
      <label class="lbl" for="inp-emp">4æ¡ã®ç¤¾å“¡ç•ªå·</label>
      <input id="inp-emp" class="inp" type="text" inputmode="numeric" maxlength="4" pattern="\d{4}" placeholder="ä¾‹ï¼š0007" autocomplete="off">
      <p id="emp-err" class="err"></p>
    </div>
    <button class="btn btn-blue" onclick="Emp.save()">æ’®å½±ã‚’å§‹ã‚ã‚‹</button>
    <p class="emp-note">â€» å¤‰æ›´ã¯ã‚«ãƒ¡ãƒ©ç”»é¢ã®ç¤¾å“¡ç•ªå·ãƒãƒƒã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
  </div>
</div>

<!-- â•â• S2: ã‚«ãƒ¡ãƒ© â•â• -->
<div id="s-cam" class="screen">
  <video id="video-el" autoplay playsinline muted></video>

  <!-- 2æ®µãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¸Šéƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="cam-top">
    <!-- 1æ®µç›®ï¼šç¤¾å“¡ç•ªå·ãƒãƒƒã‚¸ï¼ˆå·¦ï¼‰  å±¥æ­´ï¼ˆå³ï¼‰ -->
    <div class="cam-row">
      <div style="display:flex;flex-direction:column;align-items:flex-start;gap:3px">
        <button class="emp-badge" onclick="Emp.change()" aria-label="ç¤¾å“¡ç•ªå·ã‚’å¤‰æ›´">
          <span class="badge-lbl">ç¤¾å“¡ç•ªå·</span>
          <span id="cam-emp" class="badge-num">----</span>
          <span class="badge-edit">âœï¸</span>
        </button>
        <span id="cam-company" class="cam-company-lbl"></span>
      </div>
      <button class="cam-top-btn" onclick="History.open()">ğŸ“‹ å±¥æ­´</button>
    </div>
    <!-- 2æ®µç›®ï¼šâš™ï¸è¨­å®šï¼ˆå·¦ï¼‰  ç¸¦/æ¨ªå‹ï¼ˆå³ï¼‰ -->
    <div class="cam-row">
      <button class="cam-top-btn" onclick="Cfg.open()">âš™ï¸ è¨­å®š</button>
      <button id="orient-btn" class="cam-top-btn" onclick="Camera.toggleOrientation()">â†• ç¸¦å‹</button>
    </div>
  </div>

  <!-- ã‚¬ã‚¤ãƒ‰ãƒœãƒƒã‚¯ã‚¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå†…è”µï¼‰ -->
  <div id="cam-overlay" class="cam-overlay">
    <div id="guide-box" class="guide-box landscape">
      <div class="cor tl"></div><div class="cor tr"></div>
      <div class="cor bl"></div><div class="cor br"></div>
      <span id="guide-txt" class="guide-inner-txt">ååˆºã‚’æ å†…ã«<br>ã‚ã‚ã›ã¦ãã ã•ã„</span>
    </div>
  </div>

  <!-- è£é¢æ’®å½±ç¢ºèªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="back-overlay">
    <p class="back-msg">è¡¨é¢ã‚’æ’®å½±ã—ã¾ã—ãŸã€‚<br>ååˆºã®è£é¢ã‚‚ã‚ã‚Šã¾ã™ã‹ï¼Ÿ</p>
    <div class="back-btns">
      <button class="btn btn-blue" onclick="Capture.shootBack()">ğŸ“· è£é¢ã‚‚æ’®å½±ã™ã‚‹</button>
      <button class="btn btn-gray" onclick="Capture.proceedOCR()">â†’ è¡¨é¢ã ã‘ã§ç¶šã‘ã‚‹</button>
    </div>
  </div>

  <div class="cam-bot">
    <button id="shutter" class="shutter" disabled>
      <span class="shutter-dot"></span>
    </button>
  </div>
</div>

<!-- â•â• S3: å‡¦ç†ä¸­ â•â• -->
<div id="s-prog" class="screen">
  <div class="spinner"></div>
  <p id="prog-txt" class="prog-txt">èª­ã¿å–ã‚Šä¸­â€¦</p>
  <p class="prog-sub">ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</p>
</div>

<!-- â•â• S4: ç¢ºèªãƒ»ç·¨é›† â•â• -->
<div id="s-rev" class="screen">
  <div class="rev-head">
    <button class="rev-back-btn" onclick="Capture.retake()">â† æˆ»ã‚‹</button>
    <h1>ğŸ“‹ å†…å®¹ã‚’ç¢ºèªã—ã¦å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ãã ã•ã„</h1>
  </div>
  <div class="rev-body">
    <div id="rev-banner" class="banner"></div>
    <div id="dup-banner" class="dup-banner"></div>
    <div class="thumb-row">
      <img id="thumb"      class="thumb" alt="è¡¨é¢">
      <img id="thumb-back" class="thumb" alt="è£é¢" style="display:none">
    </div>
    <!-- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯Review.build()ã§å‹•çš„ç”Ÿæˆ -->
    <div id="fields-wrap"></div>

    <!-- å…¬é–‹è¨­å®š -->
    <div class="section-card">
      <div class="section-hd">ğŸ”’ å…¬é–‹è¨­å®š</div>
      <div style="padding:14px 16px">
        <p style="font-size:var(--font-small);color:var(--sub);margin-bottom:10px;line-height:1.6">
          ã“ã®ååˆºãƒ‡ãƒ¼ã‚¿ã‚’èª°ãŒè¦‹ã‚‰ã‚Œã‚‹ã‹è¨­å®šã—ã¾ã™
        </p>
        <div class="vis-group">
          <button id="vis-public" class="vis-btn active public" onclick="Review.setVisibility('public')">
            <span class="vis-icon">ğŸ‘¥</span>
            <span class="vis-label">å…¨å“¡ã«å…¬é–‹</span>
            <span class="vis-desc">å…¨ç¤¾å“¡ãŒè¦‹ã‚‰ã‚Œã¾ã™</span>
          </button>
          <button id="vis-private" class="vis-btn private" onclick="Review.setVisibility('private')">
            <span class="vis-icon">ğŸ”’</span>
            <span class="vis-label">éå…¬é–‹</span>
            <span class="vis-desc">è‡ªåˆ†ã¨ç®¡ç†è€…ã®ã¿</span>
          </button>
        </div>
      </div>
    </div>

    <!-- å‚™è€ƒ -->
    <div class="memo-card">
      <label class="lbl" for="memo">ğŸ’¬ ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
      <textarea id="memo" class="inp" rows="3" placeholder="ä¾‹ï¼šå±•ç¤ºä¼šã§å–å¾—ã€ç´¹ä»‹ã€å•†è«‡ä¸­ ãªã©"></textarea>
    </div>
  </div>
  <div class="rev-foot">
    <button class="btn btn-green" onclick="Save.run()">ç™»éŒ²ã™ã‚‹</button>
    <button class="btn btn-outline" onclick="Capture.retake()">ğŸ“· æ’®ã‚Šç›´ã™</button>
  </div>
</div>

<!-- â•â• S5: å®Œäº† â•â• -->
<div id="s-done" class="screen">
  <div class="done-inner">
    <!-- âœ…ã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ -->
    <h2 id="done-title" class="done-title"></h2>
    <p  id="done-msg"   class="done-msg"></p>
    <p  id="session-info" class="session-info"></p>

    <!-- é€ä¿¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç™»éŒ²æˆåŠŸæ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
    <div id="send-section" class="send-card" style="display:none">
      <p class="send-ttl">ğŸ“¤ ãƒ¡ãƒ¼ãƒ« / Teams ã§å…±æœ‰</p>
      <p style="font-size:13px;color:var(--sub);margin-bottom:10px;line-height:1.6">
        é€ä¿¡å½¢å¼ã¯Excelã«è²¼ã‚Šä»˜ã‘å¯èƒ½ãªå½¢å¼ï¼ˆé …ç›®ã”ã¨ã«ã‚»ãƒ«ãŒåˆ†ã‹ã‚Œã¾ã™ï¼‰
      </p>
      <div class="send-row">
        <select id="send-email-sel" class="send-sel">
          <option value="">é€ä¿¡å…ˆã‚’é¸æŠ...</option>
        </select>
        <button class="btn-mail" onclick="Send.openMail()" title="ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡">ğŸ“§</button>
      </div>
      <button class="btn-link-sm" onclick="Send.toggleAddEmail()">ï¼‹ æ–°ã—ã„ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ </button>
      <div id="send-add-box" class="send-email-box" style="display:none">
        <input id="send-email-inp" type="email" class="inp" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›" style="font-size:16px;min-height:50px">
        <button class="btn-add-email" onclick="Send.addEmail()">è¿½åŠ ã—ã¦é¸æŠ</button>
      </div>
      <div class="send-div"></div>
      <!-- "ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Teamsã§å…±æœ‰" â†’ "ç™»éŒ²å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼" ã«å¤‰æ›´ -->
      <button class="btn-teams" onclick="Send.copyForTeams()">ğŸ“‹ ç™»éŒ²å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

    <button class="btn btn-blue"    onclick="Capture.next()">ğŸ“· ç¶šã‘ã¦æ’®å½±ã™ã‚‹</button>
    <button class="btn btn-outline btn-sm" onclick="History.open()">ğŸ“‹ é€ä¿¡å±¥æ­´ã‚’è¦‹ã‚‹</button>
    <button id="retry-btn" class="btn btn-outline btn-sm" style="display:none" onclick="Save.run()">ğŸ”„ å†é€ä¿¡ã™ã‚‹</button>
  </div>
</div>

<!-- â•â• S6: é€ä¿¡å±¥æ­´ â•â• -->
<div id="s-hist" class="screen">
  <div class="hist-head">
    <h1>ğŸ“‹ é€ä¿¡å±¥æ­´ï¼ˆ7æ—¥é–“ï¼‰</h1>
    <button class="hist-back" onclick="Camera.open()">â† æˆ»ã‚‹</button>
  </div>
  <div id="hist-body" class="hist-body"></div>

  <!-- è¤‡æ•°é¸æŠæ™‚ã®ä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
  <div id="hist-batch-bar" class="hist-batch-bar">
    <p id="hist-batch-info" class="hist-batch-info"></p>
    <div class="hist-batch-btns">
      <button class="btn btn-purple btn-sm" onclick="History.batchCopy()">ğŸ“‹ ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-blue   btn-sm" onclick="History.batchMail()">ğŸ“§ ã¾ã¨ã‚ã¦ãƒ¡ãƒ¼ãƒ«</button>
    </div>
  </div>
</div>

<!-- â•â• å±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« â•â• -->
<div id="hist-modal" class="modal-overlay" onclick="if(event.target===this)History.closeModal()">
  <div class="modal-card">
    <div class="modal-head">
      <h2>ååˆºãƒ‡ãƒ¼ã‚¿ã®è©³ç´°</h2>
      <button class="modal-close" onclick="History.closeModal()">âœ• é–‰ã˜ã‚‹</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-foot">
      <button id="modal-edit-btn" class="btn btn-gray btn-sm" onclick="History.toggleEdit()">âœï¸ ç·¨é›†ã™ã‚‹</button>
      <div id="modal-send-section" style="display:none">
        <div class="send-div"></div>
        <div class="send-row" style="margin-bottom:8px">
          <select id="modal-email-sel" class="send-sel">
            <option value="">é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é¸æŠ...</option>
          </select>
          <button class="btn-mail" onclick="History.modalMail()" title="ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡">ğŸ“§</button>
        </div>
        <button class="btn-teams" onclick="History.modalCopy()">ğŸ“‹ ç™»éŒ²å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼</button>
      </div>
      <button id="modal-save-btn" class="btn btn-green" style="display:none" onclick="History.saveEdit()">ğŸ’¾ æ›´æ–°ã—ã¦ä¿å­˜</button>
    </div>
  </div>
</div>

<canvas id="work-canvas"></canvas>
<div id="_toast"></div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾© v2.5
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIELDS_SECTIONS = [
  { title: 'ğŸ¢ ä¼šç¤¾æƒ…å ±', fields: [
    {key:'companyName',   label:'ä¼šç¤¾å',           icon:'ğŸ¢', req:true },
    {key:'companyNameEn', label:'ä¼šç¤¾åï¼ˆè‹±èªï¼‰',    icon:'ğŸŒ', req:false},
  ]},
  { title: 'ğŸ—‚ï¸ æ‰€å±ï¼ˆæœ¬éƒ¨ãƒ»éƒ¨ãƒ»èª²ãªã©ï¼‰', fields: [
    {key:'affiliation1',  label:'æ‰€å± 1ï¼ˆæœ¬éƒ¨ãƒ»äº‹æ¥­éƒ¨ãªã©ï¼‰', icon:'ğŸ“', req:false},
    {key:'affiliation2',  label:'æ‰€å± 2ï¼ˆéƒ¨ãƒ»èª²ãªã©ï¼‰',       icon:'ğŸ“‚', req:false},
    {key:'affiliation3',  label:'æ‰€å± 3ï¼ˆãƒãƒ¼ãƒ ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ãªã©ï¼‰', icon:'ğŸ“„', req:false},
  ]},
  { title: 'ğŸ‘¤ æ‹…å½“è€…', fields: [
    {key:'position',    label:'å½¹è·',         icon:'ğŸ–ï¸', req:false},
    {key:'fullName',    label:'æ°åï¼ˆæ¼¢å­—ï¼‰', icon:'âœï¸',  req:true },
    {key:'fullNameEn',  label:'æ°åï¼ˆè‹±èªï¼‰', icon:'ğŸ”¤',  req:false},
    {key:'furigana',    label:'ãƒ•ãƒªã‚¬ãƒŠ',     icon:'ğŸ”¡',  req:false},
  ]},
  { title: 'ğŸ“ é€£çµ¡å…ˆ', fields: [
    {key:'officePhone', label:'é›»è©±ç•ªå·ï¼ˆä¼šç¤¾ï¼‰', icon:'ğŸ“', req:false},
    {key:'mobilePhone', label:'æºå¸¯é›»è©±ç•ªå·',     icon:'ğŸ“±', req:false},
    {key:'fax',         label:'FAX',             icon:'ğŸ“ ', req:false},
    {key:'email',       label:'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',  icon:'âœ‰ï¸', req:false},
  ]},
  { title: 'ğŸ“ ä½æ‰€ãƒ»ã‚¦ã‚§ãƒ–', fields: [
    {key:'postalCode', label:'éƒµä¾¿ç•ªå·',    icon:'ğŸ“®', req:false},
    {key:'address',    label:'ä½æ‰€',       icon:'ğŸ“', req:false},
    {key:'website',    label:'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ', icon:'ğŸŒ', req:false},
  ]},
];
const ALL_FIELDS = FIELDS_SECTIONS.flatMap(s => s.fields);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ST = {
  empId:'', base64Front:null, base64Back:null, reqId:'', ts:'',
  originalExtracted: null, ocrHint: '', visibility: 'public',
};
let camStream  = null;
let isPortrait = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS = {
  get:  k     => localStorage.getItem(k)  || '',
  set:  (k,v) => localStorage.setItem(k, v),
  del:  k     => localStorage.removeItem(k),
  gasUrl:      () => LS.get('meishi_gas_url'),
  secret:      () => LS.get('meishi_secret'),
  empId:       () => LS.get('meishi_emp'),
  companyName: () => LS.get('meishi_company_name'),
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ï¼ˆæœ€å¤§5ä»¶ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EmailMgr = {
  MAX: 5,
  getAll()     { try { return JSON.parse(LS.get('meishi_emails') || '[]'); } catch { return []; } },
  getDefault() { return LS.get('meishi_email_default') || ''; },
  setDefault(e){ LS.set('meishi_email_default', e); },
  save(list)   { LS.set('meishi_emails', JSON.stringify(list)); },
  add(email) {
    if (!email) return;
    let list = this.getAll().filter(e => e !== email);
    list.unshift(email);
    if (list.length > this.MAX) list = list.slice(0, this.MAX);
    this.save(list);
    this.setDefault(email);
  },
  remove(email) {
    const list = this.getAll().filter(e => e !== email);
    this.save(list);
    if (this.getDefault() === email) this.setDefault(list[0] || '');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€ä¿¡å±¥æ­´ç®¡ç†ï¼ˆ7æ—¥é–“ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const HistoryMgr = {
  KEY: 'meishi_send_hist', DAYS: 7,
  getAll() { try { return JSON.parse(LS.get(this.KEY) || '[]'); } catch { return []; } },
  save(items) { LS.set(this.KEY, JSON.stringify(items)); },
  add(item) {
    let items = this.getAll();
    items.unshift({
      ...item,
      id: Date.now() + '_' + Math.random().toString(36).slice(2,5),
      sendTime: new Date().toISOString(),
    });
    const cutoff = Date.now() - this.DAYS * 86400000;
    items = items.filter(i => new Date(i.sendTime).getTime() > cutoff);
    if (items.length > 200) items = items.slice(0, 200);
    this.save(items);
  },
  update(id, newItem) {
    const items = this.getAll().map(i => i.id === id ? { ...i, ...newItem } : i);
    this.save(items);
  },
  purge() {
    const cutoff = Date.now() - this.DAYS * 86400000;
    const items  = this.getAll().filter(i => new Date(i.sendTime).getTime() > cutoff);
    this.save(items);
    return items;
  },
  clear() { this.save([]); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// éƒµä¾¿ç•ªå·â†’ä½æ‰€ è‡ªå‹•å…¥åŠ›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function lookupPostalCode(code) {
  const clean = code.replace(/[^0-9]/g, '');
  if (clean.length !== 7) return null;
  try {
    const res  = await fetch('https://zipcloud.ibsnet.co.jp/api/search?zipcode=' + clean);
    const json = await res.json();
    if (json.results && json.results[0]) {
      const r = json.results[0];
      return (r.address1 || '') + (r.address2 || '') + (r.address3 || '');
    }
  } catch (_) {}
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APIé€šä¿¡ï¼ˆCORSå›é¿: text/plainï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Api = {
  async post(data) {
    const url = LS.gasUrl();
    if (!url) throw new Error('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆâš™ï¸è¨­å®šã‹ã‚‰å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰');
    let res;
    try {
      res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify({ ...data, secret: LS.secret() }),
      });
    } catch (err) {
      throw new Error('GASã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ»URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„\nãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãŒã€Œå…¨å“¡ã€ã‹ç¢ºèªã—ã¦ãã ã•ã„\nï¼ˆè©³ç´°: ' + err.message + 'ï¼‰');
    }
    if (!res.ok) throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆHTTP ' + res.status + 'ï¼‰');
    let json;
    try { json = await res.json(); } catch { throw new Error('GASã‹ã‚‰ã®è¿”ç­”ãŒèª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }
    return json;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç”»é¢é·ç§»ï¼ˆs-rev ã¯å¿…ãšãƒˆãƒƒãƒ—ã¸ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  el.classList.add('active');
  el.scrollTop = 0;
  window.scrollTo(0, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S0: æ¥ç¶šè¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Cfg = {
  open() {
    document.getElementById('cfg-url').value    = LS.gasUrl();
    document.getElementById('cfg-secret').value = LS.secret();
    _hideBanner('cfg-banner');
    this.refreshEmailList();
    Camera.stop();
    show('s-cfg');
  },

  refreshEmailList() {
    const wrap = document.getElementById('cfg-email-list');
    if (!wrap) return;
    const emails = EmailMgr.getAll();
    const def    = EmailMgr.getDefault();
    if (!emails.length) {
      wrap.innerHTML = '<p style="font-size:13px;color:var(--sub);padding:4px 0">ã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
      return;
    }
    wrap.innerHTML = emails.map(e => `
      <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:#fff;border:1.5px solid ${e===def?'var(--blue)':'var(--border)'};border-radius:8px;font-size:14px;margin-top:6px">
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e===def?'â­ ':''}${e}</span>
        ${e !== def ? `<button onclick="Cfg.setDefault('${e}')" style="background:none;border:1px solid var(--blue);color:var(--blue);border-radius:4px;font-size:12px;padding:2px 8px;cursor:pointer">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</button>` : ''}
        <button onclick="Cfg.removeEmail('${e}')" style="background:none;border:none;color:var(--red);font-size:18px;cursor:pointer">âœ•</button>
      </div>`).join('');
  },

  toggleEmailBox() {
    const box  = document.getElementById('cfg-email-box');
    const open = box.style.display === 'none' || box.style.display === '';
    box.style.display = open ? 'flex' : 'none';
    if (open) document.getElementById('cfg-email-inp').focus();
  },

  addEmail() {
    const inp   = document.getElementById('cfg-email-inp');
    const email = inp.value.trim();
    if (!email || !email.includes('@')) { _showBanner('cfg-banner', 'err', 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    EmailMgr.add(email);
    inp.value = '';
    document.getElementById('cfg-email-box').style.display = 'none';
    this.refreshEmailList();
    _showBanner('cfg-banner', 'ok', 'âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  },

  setDefault(email) { EmailMgr.setDefault(email); this.refreshEmailList(); },
  removeEmail(email) { EmailMgr.remove(email); this.refreshEmailList(); },

  async test() {
    const url    = document.getElementById('cfg-url').value.trim();
    const secret = document.getElementById('cfg-secret').value.trim();
    if (!url)    return _showBanner('cfg-banner', 'err', 'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!secret) return _showBanner('cfg-banner', 'err', 'åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!url.includes('script.google.com')) return _showBanner('cfg-banner', 'err', 'URLãŒGASã®URLã§ã¯ãªã„ã‚ˆã†ã§ã™');
    _showBanner('cfg-banner', 'warn', 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­â€¦');
    try {
      const res  = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({action:'test', secret}) });
      const json = await res.json();
      if (json.code === 'E040') {
        _showBanner('cfg-banner', 'err', 'âŒ åˆè¨€è‘‰ãŒé•ã„ã¾ã™');
      } else if (json.ok || json.code === 'OK') {
        const cname = json.companyName || '';
        if (cname && cname !== 'ï¼ˆä¼šç¤¾åæœªè¨­å®šï¼‰') {
          LS.set('meishi_company_name', cname);
          _showBanner('cfg-banner', 'ok', 'âœ… æ¥ç¶šæˆåŠŸï¼\nğŸ¢ æ¥ç¶šå…ˆï¼š' + cname);
        } else {
          _showBanner('cfg-banner', 'ok', 'âœ… æ¥ç¶šæˆåŠŸï¼GASã¨é€šä¿¡ã§ãã¦ã„ã¾ã™');
        }
      } else {
        _showBanner('cfg-banner', 'ok', 'âœ… æ¥ç¶šæˆåŠŸï¼ˆã‚³ãƒ¼ãƒ‰: ' + json.code + 'ï¼‰');
      }
    } catch (err) {
      _showBanner('cfg-banner', 'err', 'âŒ æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ\n\nåŸå› :\nâ‘  URLãŒé–“é•ã£ã¦ã„ã‚‹\nâ‘¡ ã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãŒã€Œå…¨å“¡ã€ã§ãªã„\n\nè©³ç´°: ' + err.message);
    }
  },

  async save() {
    const url    = document.getElementById('cfg-url').value.trim();
    const secret = document.getElementById('cfg-secret').value.trim();
    if (!url)    return _showBanner('cfg-banner', 'err', 'URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!secret) return _showBanner('cfg-banner', 'err', 'åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!url.startsWith('https://script.google.com')) return _showBanner('cfg-banner', 'err', 'URLãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™');
    if (!url.endsWith('/exec')) return _showBanner('cfg-banner', 'err', 'URLã¯ /exec ã§çµ‚ã‚ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
    LS.set('meishi_gas_url', url);
    LS.set('meishi_secret',  secret);
    try {
      const res  = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=UTF-8'}, body: JSON.stringify({action:'test', secret}) });
      const json = await res.json();
      if (json.companyName && json.companyName !== 'ï¼ˆä¼šç¤¾åæœªè¨­å®šï¼‰') LS.set('meishi_company_name', json.companyName);
    } catch (_) {}
    const empId = LS.empId();
    if (empId && /^\d{4}$/.test(empId)) { ST.empId = empId; _refreshBadge(); Camera.open(); }
    else show('s-emp');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S1: ç¤¾å“¡ç•ªå·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Emp = {
  save() {
    const val = document.getElementById('inp-emp').value.trim();
    const err = document.getElementById('emp-err');
    if (!/^\d{4}$/.test(val)) { err.textContent = 'âŒ 0ã€œ9ã®4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š0007ï¼‰'; err.classList.add('show'); return; }
    err.classList.remove('show');
    ST.empId = val;
    LS.set('meishi_emp', val);
    _refreshBadge();
    Camera.open();
  },
  change() { Camera.stop(); document.getElementById('inp-emp').value = ST.empId; show('s-emp'); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S2: ã‚«ãƒ¡ãƒ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Camera = {
  async open() {
    show('s-cam');
    _refreshBadge();
    document.getElementById('back-overlay').classList.remove('show');
    document.getElementById('shutter').onclick = () => Capture.shoot();
    await this.start();
  },
  async start() {
    try {
      if (camStream) this.stop();
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } }, audio: false,
      });
      const v = document.getElementById('video-el');
      v.srcObject = camStream;
      v.onloadedmetadata = () => { document.getElementById('shutter').disabled = false; };
    } catch (err) {
      Result.show('error', 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼',
        err.name === 'NotAllowedError'
          ? 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„'
          : 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„\nï¼ˆ' + err.message + 'ï¼‰');
    }
  },
  stop() {
    if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
    const s = document.getElementById('shutter');
    if (s) s.disabled = true;
  },
  toggleOrientation() {
    isPortrait = !isPortrait;
    const box = document.getElementById('guide-box');
    const btn = document.getElementById('orient-btn');
    const txt = document.getElementById('guide-txt');
    // ãƒ†ã‚­ã‚¹ãƒˆã¯ç¸¦æ¨ªå…±é€š
    txt.innerHTML = 'ååˆºã‚’æ å†…ã«<br>ã‚ã‚ã›ã¦ãã ã•ã„';
    if (isPortrait) {
      box.className   = 'guide-box portrait';
      btn.textContent = 'â†” æ¨ªå‹';
      btn.classList.add('active');
    } else {
      box.className   = 'guide-box landscape';
      btn.textContent = 'â†• ç¸¦å‹';
      btn.classList.remove('active');
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ’®å½±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Capture = {
  shoot() {
    const v      = document.getElementById('video-el');
    const canvas = document.getElementById('work-canvas');
    canvas.width  = v.videoWidth  || 1280;
    canvas.height = v.videoHeight || 720;
    canvas.getContext('2d').drawImage(v, 0, 0);
    ST.base64Front = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
    ST.base64Back  = null;
    ST.reqId = 'R' + Date.now() + Math.random().toString(36).slice(2,6);
    ST.ts    = new Date().toISOString();

    const tb = document.getElementById('thumb');
    tb.src = canvas.toDataURL('image/jpeg', 0.82);
    tb.style.display = 'block';
    document.getElementById('thumb-back').style.display = 'none';

    document.getElementById('back-overlay').classList.add('show');
    const shutter = document.getElementById('shutter');
    shutter.onclick = () => Capture.shoot();
  },

  shootBack() {
    const v      = document.getElementById('video-el');
    const canvas = document.getElementById('work-canvas');
    canvas.width  = v.videoWidth  || 1280;
    canvas.height = v.videoHeight || 720;
    canvas.getContext('2d').drawImage(v, 0, 0);
    ST.base64Back = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];

    const tb = document.getElementById('thumb-back');
    tb.src = canvas.toDataURL('image/jpeg', 0.82);
    tb.style.display = 'block';

    document.getElementById('shutter').onclick = () => Capture.shoot();
    this.proceedOCR();
  },

  async proceedOCR() {
    document.getElementById('back-overlay').classList.remove('show');
    Camera.stop();
    _setProgress('ååˆºã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦');
    show('s-prog');

    let extracted = {}, warnMsg = '', isDupWarn = false, dupData = null;

    try {
      const payload = { action:'extract', imageBase64:ST.base64Front, employeeId:ST.empId, timestamp:ST.ts };
      if (ST.base64Back) payload.imageBase64Back = ST.base64Back;
      const res = await Api.post(payload);
      if (res.ok) {
        extracted = res.extracted || {};
        ST.originalExtracted = JSON.parse(JSON.stringify(extracted));
        ST.ocrHint = res.ocrHint || '';
        if (Object.values(extracted).filter(v => v && v.trim()).length === 0)
          warnMsg = 'âš ï¸ æ–‡å­—ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸãŒæƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ\né …ç›®ã‚’æ‰‹å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™';
      } else {
        warnMsg = 'âš ï¸ èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ï¼ˆ' + (res.code||'?') + 'ï¼‰\n' + (res.message||'') + '\n\næ‰‹å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™';
      }
    } catch (err) {
      warnMsg = 'âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼\n' + err.message + '\n\næ‰‹å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™';
    }

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
    if (extracted.email || (extracted.fullName && extracted.companyName)) {
      try {
        const dup = await Api.post({ action:'checkDuplicate', employeeId:ST.empId, email:extracted.email||'', fullName:extracted.fullName||'', companyName:extracted.companyName||'', position:extracted.position||'', affiliation1:extracted.affiliation1||'' });
        if (dup.isDuplicate) { isDupWarn = true; dupData = dup; }
      } catch (_) {}
    }

    Review.build(extracted, warnMsg, isDupWarn, dupData);
    show('s-rev');
  },

  retake() { document.getElementById('shutter').onclick = () => Capture.shoot(); Camera.open(); },
  next()   { document.getElementById('shutter').onclick = () => Capture.shoot(); Camera.open(); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S4: ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Review = {
  _vis: 'public',

  build(data, warnMsg, isDupWarn, dupData) {
    this._vis = 'public';
    this.setVisibility('public');

    const banner = document.getElementById('rev-banner');
    if (warnMsg) { banner.textContent = warnMsg; banner.className = 'banner warn show'; }
    else         { banner.className = 'banner'; }

    const dup = document.getElementById('dup-banner');
    if (isDupWarn && dupData) {
      const msg = dupData.sameRole
        ? `âš ï¸ åŒã˜æ–¹ã®ååˆºãŒã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ï¼ˆ${dupData.existingData.fullName} / ${dupData.existingData.companyName}ï¼‰\nãã®ã¾ã¾ç™»éŒ²ã™ã‚‹å ´åˆã¯ã€Œç™»éŒ²ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„`
        : `â„¹ï¸ åŒã˜æ–¹ã®ååˆºãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸãŒã€å½¹è·ãƒ»æ‰€å±ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™ï¼ˆ${dupData.existingData.position} â†’ å¤‰æ›´ï¼‰\nã“ã®ã¾ã¾æ–°è¦ç™»éŒ²ã§ãã¾ã™`;
      dup.innerHTML = '<strong>' + msg + '</strong>';
      dup.classList.add('show');
    } else { dup.classList.remove('show'); }

    document.getElementById('fields-wrap').innerHTML =
      FIELDS_SECTIONS.map(sec => `
        <div class="section-card">
          <div class="section-hd">${sec.title}</div>
          ${sec.fields.map(f => {
            const val = data[f.key] || '';
            const isPostal = f.key === 'postalCode';
            return `<div class="f-row${val ? ' filled' : ''}" id="frow-${f.key}">
              <label class="lbl" for="f-${f.key}">
                <span class="lbl-icon">${f.icon}</span>${f.label}${f.req ? '<span class="req">å¿…é ˆ</span>' : ''}
              </label>
              <div class="f-input-wrap">
                <input id="f-${f.key}" class="inp" type="text" value="${_esc(val)}"
                  placeholder="ï¼ˆç©ºæ¬„ã§ã‚‚ç™»éŒ²ã§ãã¾ã™ï¼‰"
                  oninput="Review._onInput('${f.key}',this)"
                  ${isPostal ? `onblur="Review._onPostal(this)"` : ''}>
                <button class="f-clear-btn" onclick="Review.clearField('${f.key}')" title="ã‚¯ãƒªã‚¢">âœ•</button>
              </div>
              ${isPostal ? `<span id="postal-hint-${f.key}" class="postal-hint">ğŸ“ ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ä¸­...</span>` : ''}
            </div>`;
          }).join('')}
        </div>`).join('');

    document.getElementById('memo').value = '';
  },

  _onInput(key, el) {
    const row = document.getElementById('frow-' + key);
    if (row) row.classList.toggle('filled', !!el.value);
  },

  async _onPostal(el) {
    const code = el.value.replace(/[^0-9]/g, '');
    if (code.length !== 7) return;
    const hint = document.getElementById('postal-hint-postalCode');
    if (hint) { hint.textContent = 'ğŸ“ ä½æ‰€ã‚’æ¤œç´¢ä¸­...'; hint.classList.add('show'); }
    const addr = await lookupPostalCode(code);
    if (hint) hint.classList.remove('show');
    if (addr) {
      const addrEl = document.getElementById('f-address');
      if (addrEl && !addrEl.value) {
        addrEl.value = addr;
        const row = document.getElementById('frow-address');
        if (row) row.classList.add('filled');
        _showToast('ğŸ“ ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ');
      }
    }
  },

  clearField(key) {
    const el = document.getElementById('f-' + key);
    if (el) { el.value = ''; const row = document.getElementById('frow-' + key); if (row) row.classList.remove('filled'); }
  },

  setVisibility(v) {
    this._vis = v;
    document.getElementById('vis-public') .classList.toggle('active', v === 'public');
    document.getElementById('vis-private').classList.toggle('active', v === 'private');
  },

  getData() {
    const d = {};
    ALL_FIELDS.forEach(f => { d[f.key] = (document.getElementById('f-' + f.key) || {}).value || ''; });
    return d;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç™»éŒ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Save = {
  _lastData: null,

  async run() {
    _setProgress('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç™»éŒ²ä¸­â€¦');
    show('s-prog');
    const memoVal = document.getElementById('memo').value;
    const revData = Review.getData();
    this._lastData = { ...revData, memo: memoVal };

    try {
      const res = await Api.post({
        action:'save', data:revData, employeeId:ST.empId, timestamp:ST.ts,
        requestId:ST.reqId, memo:memoVal, visibility:Review._vis,
        originalExtracted:ST.originalExtracted, ocrHint:ST.ocrHint,
      });
      if (res.status === 'DUPLICATE') {
        Result.show('info', 'ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™', 'ã“ã®ååˆºã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ï¼ˆé‡è¤‡é€ä¿¡ã‚’é˜²æ­¢ã—ã¾ã—ãŸï¼‰');
      } else if (res.ok) {
        // requestIdã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆupdateRecordç”¨ï¼‰
        if (res.requestId) ST.reqId = res.requestId;
        Send.setCurrentData(revData, memoVal);
        Result.show(
          res.status === 'SUCCESS' ? 'success' : 'warn',
          'ç™»éŒ²å®Œäº†',
          res.status === 'SUCCESS' ? 'ååˆºãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¾ã—ãŸ' : 'ç™»éŒ²ã—ã¾ã—ãŸï¼ˆå†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰',
          false, true
        );
      } else {
        throw new Error(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ¼ãƒ‰: ' + (res.code||'?') + 'ï¼‰');
      }
    } catch (err) {
      Result.show('error', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', err.message, true, false);
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€ä¿¡ï¼ˆãƒ¡ãƒ¼ãƒ« / Teamsï¼‰v2.5: TSVå½¢å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Send = {
  _data: null,

  setCurrentData(data, memo) { this._data = { ...data, memo }; },

  // Excelè²¼ã‚Šä»˜ã‘ç”¨TSVï¼ˆé …ç›®å\tå€¤ ã‚’1è¡Œãšã¤ï¼‰
  formatTSV(data) {
    const d = data || this._data;
    if (!d) return '';
    let rows = [];
    ALL_FIELDS.forEach(f => { if (d[f.key]) rows.push(f.label + '\t' + d[f.key]); });
    if (d.memo) rows.push('ãƒ¡ãƒ¢\t' + d.memo);
    rows.push('ç¤¾å“¡ç•ªå·\t' + ST.empId + '\tæ’®å½±æ—¥æ™‚\t' + new Date().toLocaleString('ja-JP'));
    return rows.join('\n');
  },

  // è¤‡æ•°ä»¶ã®TSVï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼‹ãƒ‡ãƒ¼ã‚¿è¡Œï¼‰
  formatMultiTSV(items) {
    const headers = ALL_FIELDS.map(f => f.label).join('\t');
    const rows = items.map(item => {
      const d = item.fullData || {};
      return ALL_FIELDS.map(f => (d[f.key] || '')).join('\t');
    });
    return headers + '\n' + rows.join('\n');
  },

  refreshSelect() {
    const sel = document.getElementById('send-email-sel');
    if (!sel) return;
    const emails = EmailMgr.getAll();
    const def    = EmailMgr.getDefault();
    sel.innerHTML = '<option value="">é€ä¿¡å…ˆã‚’é¸æŠ...</option>' +
      emails.map(e => `<option value="${e}" ${e===def?'selected':''}>${e}</option>`).join('');
  },

  show() { const s = document.getElementById('send-section'); if (s) { s.style.display='block'; this.refreshSelect(); } },
  hide() { const s = document.getElementById('send-section'); if (s) s.style.display='none'; },

  toggleAddEmail() {
    const box  = document.getElementById('send-add-box');
    const open = box.style.display === 'none' || box.style.display === '';
    box.style.display = open ? 'flex' : 'none';
    if (open) document.getElementById('send-email-inp').focus();
  },

  addEmail() {
    const inp   = document.getElementById('send-email-inp');
    const email = inp.value.trim();
    if (!email || !email.includes('@')) { _showToast('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    EmailMgr.add(email);
    inp.value = '';
    document.getElementById('send-add-box').style.display = 'none';
    this.refreshSelect();
    _showToast('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
  },

  // GASçµŒç”±ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆè¿·æƒ‘ãƒ¡ãƒ¼ãƒ«å¯¾ç­–ï¼‰
  async openMail(data) {
    const sel   = document.getElementById('send-email-sel');
    const email = sel ? sel.value : '';
    if (!email) { _showToast('é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    const d = data || this._data || {};
    const subject = 'ååˆºãƒ‡ãƒ¼ã‚¿: ' + (d.companyName||'') + ' ' + (d.fullName||'');
    const body    = this.formatTSV(d);
    _showToast('é€ä¿¡ä¸­â€¦');
    try {
      const res = await Api.post({ action:'sendEmail', to:email, subject, body });
      if (res.ok) {
        _showToast('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
        EmailMgr.add(email);
        this.refreshSelect();
        HistoryMgr.add({ sendType:'email', recipient:email, fullData:d,
          companyName:d.companyName||'', affiliation1:d.affiliation1||'', affiliation2:d.affiliation2||'',
          affiliation3:d.affiliation3||'', position:d.position||'', fullName:d.fullName||'',
          requestId:ST.reqId, employeeId:ST.empId });
      } else {
        _showToast('âŒ ' + (res.message||'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'));
      }
    } catch (err) {
      _showToast('âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + err.message);
    }
  },

  // ç™»éŒ²å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆTSVå½¢å¼ï¼‰
  async copyForTeams(data) {
    const d   = data || this._data;
    const tsv = this.formatTSV(d);
    try {
      await navigator.clipboard.writeText(tsv);
      _showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Excelã‚„Teamsã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
    } catch {
      prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Excelãƒ»Teamsã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:', tsv);
    }
    const dd = d || {};
    HistoryMgr.add({ sendType:'copy', recipient:'ã‚³ãƒ”ãƒ¼', fullData:dd,
      companyName:dd.companyName||'', affiliation1:dd.affiliation1||'', affiliation2:dd.affiliation2||'',
      affiliation3:dd.affiliation3||'', position:dd.position||'', fullName:dd.fullName||'',
      requestId:ST.reqId, employeeId:ST.empId });
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S5: å®Œäº†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Result = {
  _count: 0,
  show(type, title, msg, showRetry = false, showSend = false) {
    // âœ…ã‚¢ã‚¤ã‚³ãƒ³ã¯è¡¨ç¤ºã—ãªã„ï¼ˆv2.5ï¼‰
    document.getElementById('done-title').textContent = title;
    document.getElementById('done-msg')  .textContent = msg;
    document.getElementById('retry-btn').style.display = showRetry ? 'flex' : 'none';
    if (showSend) {
      this._count++;
      document.getElementById('session-info').textContent = 'ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³: ' + this._count + 'æšç™»éŒ²æ¸ˆã¿';
      Send.show();
    } else { Send.hide(); }
    show('s-done');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S6: é€ä¿¡å±¥æ­´
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const History = {
  _selected: new Set(),
  _editMode:  false,
  _modalItem: null,

  open() {
    this._selected.clear();
    _updateBatchBar(0);
    this.render();
    show('s-hist');
  },

  render() {
    const items = HistoryMgr.purge();
    const body  = document.getElementById('hist-body');
    if (!items.length) {
      body.innerHTML = '<p class="hist-empty">ğŸ“­ é€ä¿¡å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“<br>ï¼ˆ7æ—¥é–“ä¿æŒã•ã‚Œã¾ã™ï¼‰</p>';
      return;
    }

    const typeLabel = { email:'ğŸ“§ ãƒ¡ãƒ¼ãƒ«', teams:'ğŸ’¬ Teams', copy:'ğŸ“‹ ã‚³ãƒ”ãƒ¼' };
    const typeCls   = { email:'email', teams:'teams', copy:'email' };

    body.innerHTML = items.map(item => {
      const dt     = new Date(item.sendTime).toLocaleString('ja-JP');
      const affils = [item.affiliation1, item.affiliation2, item.affiliation3].filter(Boolean).join(' / ');
      const checked = this._selected.has(item.id);
      return `<div class="hist-item ${typeCls[item.sendType]||''} ${checked?'selected':''}" data-id="${item.id}">
        <div class="hist-check ${checked?'on':''}" onclick="event.stopPropagation();History.toggleSelect('${item.id}')">
          ${checked ? 'âœ“' : ''}
        </div>
        <div class="hist-info" onclick="History.openModal('${item.id}')">
          <span class="hist-type ${typeCls[item.sendType]||'email'}">${typeLabel[item.sendType]||'ğŸ“‹'}</span>
          <p class="hist-company">${_esc(item.companyName||'ï¼ˆä¼šç¤¾åãªã—ï¼‰')}</p>
          <p class="hist-person">${_esc(item.position||'')} ${_esc(item.fullName||'ï¼ˆæ°åãªã—ï¼‰')}</p>
          ${affils ? `<p class="hist-affil">${_esc(affils)}</p>` : ''}
          <p class="hist-time">ğŸ“… ${dt}ã€€${item.recipient ? 'â†’ '+_esc(item.recipient) : ''}</p>
        </div>
      </div>`;
    }).join('') + `<button class="hist-clear-btn" onclick="HistoryMgr.clear();History.render()">ğŸ—‘ï¸ å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>`;
  },

  toggleSelect(id) {
    if (this._selected.has(id)) this._selected.delete(id);
    else this._selected.add(id);
    this.render();
    _updateBatchBar(this._selected.size);
  },

  // ä¸€æ‹¬ã‚³ãƒ”ãƒ¼ï¼ˆTSVè¤‡æ•°è¡Œï¼‰
  async batchCopy() {
    const items = HistoryMgr.getAll().filter(i => this._selected.has(i.id));
    if (!items.length) return;
    const tsv = Send.formatMultiTSV(items);
    try {
      await navigator.clipboard.writeText(tsv);
      _showToast('ğŸ“‹ ' + items.length + 'ä»¶ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Excelã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
    } catch {
      prompt('ä»¥ä¸‹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Excelã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:', tsv);
    }
  },

  // ä¸€æ‹¬ãƒ¡ãƒ¼ãƒ«é€ä¿¡
  async batchMail() {
    const sel   = document.getElementById('send-email-sel');
    let email = sel ? sel.value : EmailMgr.getDefault();
    if (!email) {
      email = prompt('é€ä¿¡å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if (!email || !email.includes('@')) { _showToast('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    }
    const items   = HistoryMgr.getAll().filter(i => this._selected.has(i.id));
    if (!items.length) return;
    const subject = 'ååˆºãƒ‡ãƒ¼ã‚¿ä¸€æ‹¬é€ä¿¡ï¼ˆ' + items.length + 'ä»¶ï¼‰';
    const body    = Send.formatMultiTSV(items);
    _showToast('é€ä¿¡ä¸­â€¦');
    try {
      const res = await Api.post({ action:'sendEmail', to:email, subject, body });
      _showToast(res.ok ? 'ğŸ“§ ' + items.length + 'ä»¶ã‚’é€ä¿¡ã—ã¾ã—ãŸ' : 'âŒ ' + (res.message||'é€ä¿¡å¤±æ•—'));
    } catch (err) { _showToast('âŒ ' + err.message); }
  },

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆé–²è¦§ãƒ»ç·¨é›†ï¼‰
  openModal(id) {
    const item = HistoryMgr.getAll().find(i => i.id === id);
    if (!item) return;
    this._modalItem = item;
    this._editMode  = false;
    this._renderModal(item, false);
    document.getElementById('hist-modal').classList.add('show');
    // ãƒ¡ãƒ¼ãƒ«é¸æŠè‚¢ã‚’æ›´æ–°
    const sel = document.getElementById('modal-email-sel');
    if (sel) {
      const emails = EmailMgr.getAll();
      const def    = EmailMgr.getDefault();
      sel.innerHTML = '<option value="">é€ä¿¡å…ˆã‚’é¸æŠ...</option>' +
        emails.map(e => `<option value="${e}" ${e===def?'selected':''}>${e}</option>`).join('');
    }
    document.getElementById('modal-send-section').style.display = 'block';
    document.getElementById('modal-save-btn').style.display      = 'none';
    document.getElementById('modal-edit-btn').textContent        = 'âœï¸ ç·¨é›†ã™ã‚‹';
  },

  closeModal() {
    document.getElementById('hist-modal').classList.remove('show');
    this._modalItem = null;
    this._editMode  = false;
  },

  _renderModal(item, editMode) {
    const d    = item.fullData || {};
    const body = document.getElementById('modal-body');
    body.innerHTML = ALL_FIELDS.map(f => {
      const val = d[f.key] || '';
      if (!val && !editMode) return '';
      return `<div class="modal-field-row">
        <span class="modal-lbl">${f.icon} ${f.label}</span>
        ${editMode
          ? `<input class="modal-inp" id="medit-${f.key}" value="${_esc(val)}" placeholder="ï¼ˆç©ºæ¬„å¯ï¼‰">`
          : `<span class="modal-val">${_esc(val) || 'â€”'}</span>`}
      </div>`;
    }).join('') +
    (item.memo || editMode ? `<div class="modal-field-row">
      <span class="modal-lbl">ğŸ’¬ ãƒ¡ãƒ¢</span>
      ${editMode ? `<input class="modal-inp" id="medit-memo" value="${_esc(item.memo||'')}">` : `<span class="modal-val">${_esc(item.memo||'')}</span>`}
    </div>` : '');
  },

  toggleEdit() {
    this._editMode = !this._editMode;
    this._renderModal(this._modalItem, this._editMode);
    document.getElementById('modal-edit-btn').textContent       = this._editMode ? 'ğŸ‘ é–²è¦§ã«æˆ»ã‚‹' : 'âœï¸ ç·¨é›†ã™ã‚‹';
    document.getElementById('modal-save-btn').style.display     = this._editMode ? 'flex' : 'none';
    document.getElementById('modal-send-section').style.display = this._editMode ? 'none' : 'block';
  },

  // ç·¨é›†å†…å®¹ã‚’ä¿å­˜ï¼ˆæ—¢å­˜è¡Œã‚’ä¸Šæ›¸ããƒ»æ–°è¡Œã¯è¿½åŠ ã—ãªã„ï¼‰
  async saveEdit() {
    if (!this._modalItem) return;
    const item = this._modalItem;
    const newData = {};
    ALL_FIELDS.forEach(f => {
      const el = document.getElementById('medit-' + f.key);
      if (el) newData[f.key] = el.value;
    });
    const memoEl = document.getElementById('medit-memo');
    const memo   = memoEl ? memoEl.value : '';

    _showToast('ä¿å­˜ä¸­â€¦');
    try {
      if (item.requestId) {
        const res = await Api.post({
          action:'updateRecord', requestId:item.requestId,
          data:newData, memo, visibility:item.visibility||'public',
          employeeId:item.employeeId||ST.empId, timestamp:item.sendTime||'',
        });
        if (!res.ok) throw new Error(res.message);
      }
      // HistoryMgrã‚‚æ›´æ–°
      HistoryMgr.update(item.id, { fullData:newData, memo,
        companyName:newData.companyName||'', fullName:newData.fullName||'',
        position:newData.position||'', affiliation1:newData.affiliation1||'',
        affiliation2:newData.affiliation2||'', affiliation3:newData.affiliation3||'' });
      this._modalItem = { ...item, fullData:newData, memo };
      _showToast('âœ… æ›´æ–°ã—ã¾ã—ãŸ');
      this._editMode = false;
      this._renderModal(this._modalItem, false);
      document.getElementById('modal-edit-btn').textContent       = 'âœï¸ ç·¨é›†ã™ã‚‹';
      document.getElementById('modal-save-btn').style.display     = 'none';
      document.getElementById('modal-send-section').style.display = 'block';
      this.render();
    } catch (err) { _showToast('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + err.message); }
  },

  modalMail()  { Send.openMail(this._modalItem ? this._modalItem.fullData : null); },
  modalCopy()  { Send.copyForTeams(this._modalItem ? this._modalItem.fullData : null); },
};

function _updateBatchBar(count) {
  const bar  = document.getElementById('hist-batch-bar');
  const info = document.getElementById('hist-batch-info');
  if (count > 0) {
    bar.classList.add('show');
    info.textContent = count + 'ä»¶ã‚’é¸æŠä¸­';
  } else {
    bar.classList.remove('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _refreshBadge() {
  const el = document.getElementById('cam-emp');
  if (el) el.textContent = ST.empId || '----';
  const cn   = document.getElementById('cam-company');
  const name = LS.companyName();
  if (cn) {
    if (name && name !== 'ï¼ˆä¼šç¤¾åæœªè¨­å®šï¼‰') { cn.textContent = 'ğŸ¢ ' + name; cn.style.display = ''; }
    else { cn.style.display = 'none'; }
  }
}
function _setProgress(txt) { const el = document.getElementById('prog-txt'); if (el) el.textContent = txt; }
function _showBanner(id, type, msg) { const el = document.getElementById(id); if (!el) return; el.textContent = msg; el.className = 'banner ' + type + ' show'; }
function _hideBanner(id) { const el = document.getElementById(id); if (el) el.className = 'banner'; }
function toggleEye(inputId, btn) { const el = document.getElementById(inputId); const v = el.type==='password'; el.type = v?'text':'password'; btn.textContent = v?'ğŸ™ˆ':'ğŸ‘'; }
function _showToast(msg) { const t = document.getElementById('_toast'); t.textContent = msg; t.style.opacity = '1'; clearTimeout(t._tmr); t._tmr = setTimeout(() => { t.style.opacity = '0'; }, 2800); }
function _esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// èµ·å‹•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  HistoryMgr.purge();
  const gasUrl = LS.gasUrl();
  const secret = LS.secret();
  const empId  = LS.empId();
  if (!gasUrl || !secret) { show('s-cfg'); Cfg.refreshEmailList(); return; }
  if (!empId || !/^\d{4}$/.test(empId)) { show('s-emp'); return; }
  ST.empId = empId;
  _refreshBadge();
  Camera.open();
});
</script>
</body>
</html>
