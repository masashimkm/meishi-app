<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ååˆºæ›¸ãå‡ºã—å›">
  <link rel="manifest" href="manifest.json">
  <title>ååˆºæ›¸ãå‡ºã—å›</title>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    :root{
      --blue:#1a73e8;--blue-dk:#1557b0;--blue-lt:#e8f0fe;
      --green:#1e8e3e;--green-bg:#e6f4ea;
      --red:#c5221f;--red-bg:#fce8e6;
      --warn:#b06000;--warn-bg:#fef7e0;
      --text:#202124;--sub:#5f6368;--border:#dadce0;--bg:#f8f9fa;
      --radius:14px;
    }
    html,body{height:100%;height:100dvh;font-family:-apple-system,'Hiragino Sans',sans-serif;
      font-size:17px;color:var(--text);background:var(--bg);overflow:hidden}

    /* â”€â”€ ç”»é¢ç®¡ç† â”€â”€ */
    .screen{position:fixed;inset:0;display:none;flex-direction:column;
      overflow-y:auto;-webkit-overflow-scrolling:touch}
    .screen.active{display:flex}

    /* â”€â”€ å…±é€šãƒœã‚¿ãƒ³ â”€â”€ */
    .btn{display:flex;align-items:center;justify-content:center;gap:8px;
      width:100%;min-height:58px;padding:0 20px;border:none;border-radius:var(--radius);
      font-size:18px;font-weight:700;cursor:pointer;transition:opacity .15s}
    .btn:active{opacity:.75}
    .btn-blue  {background:var(--blue);color:#fff}
    .btn-green {background:var(--green);color:#fff}
    .btn-outline{background:#fff;color:var(--blue);border:2.5px solid var(--blue)}
    .btn-gray  {background:#e8eaed;color:var(--text)}
    .btn-sm    {min-height:46px;font-size:15px}

    /* â”€â”€ å…±é€šãƒ•ã‚©ãƒ¼ãƒ  â”€â”€ */
    .lbl{display:block;font-size:13px;font-weight:700;color:var(--sub);margin-bottom:5px}
    .inp{width:100%;padding:13px 14px;font-size:16px;border:2px solid var(--border);
      border-radius:10px;background:#fff;color:var(--text);transition:border-color .15s;
      -webkit-appearance:none}
    .inp:focus{border-color:var(--blue);outline:none}
    .inp-wrap{position:relative}
    .inp-wrap .inp{padding-right:48px}
    .eye-btn{position:absolute;right:12px;top:50%;transform:translateY(-50%);
      background:none;border:none;font-size:20px;cursor:pointer;color:var(--sub)}
    .err{font-size:14px;color:var(--red);margin-top:6px;display:none}
    .err.show{display:block}

    /* â”€â”€ ãƒãƒŠãƒ¼ï¼ˆã‚¨ãƒ©ãƒ¼/è­¦å‘Š/æˆåŠŸï¼‰ â”€â”€ */
    .banner{padding:14px 16px;border-radius:10px;font-size:15px;font-weight:600;
      line-height:1.6;white-space:pre-wrap;display:none}
    .banner.show{display:block}
    .banner.err {background:var(--red-bg);color:var(--red)}
    .banner.warn{background:var(--warn-bg);color:var(--warn)}
    .banner.ok  {background:var(--green-bg);color:var(--green)}

    /* â”€â”€ ã‚¹ãƒ”ãƒŠãƒ¼ â”€â”€ */
    .spinner{width:44px;height:44px;border:5px solid var(--border);
      border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       S0: æ¥ç¶šè¨­å®šç”»é¢
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-cfg{background:var(--blue);align-items:center;justify-content:center;padding:20px}
    .cfg-card{background:#fff;border-radius:20px;padding:28px 24px;
      width:100%;max-width:420px;display:flex;flex-direction:column;gap:18px;
      box-shadow:0 8px 32px rgba(0,0,0,.2)}
    .cfg-title{font-size:20px;font-weight:800;text-align:center}
    .cfg-sub  {font-size:14px;color:var(--sub);text-align:center;line-height:1.6}
    .cfg-field{display:flex;flex-direction:column;gap:5px}
    .cfg-hint {font-size:12px;color:var(--sub);line-height:1.6;margin-top:4px}
    .cfg-hint b{color:var(--blue)}
    .cfg-divider{border:none;border-top:1px solid var(--border)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       S1: ç¤¾å“¡ç•ªå·è¨­å®š
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-emp{background:var(--blue);align-items:center;justify-content:center;padding:20px}
    .emp-card{background:#fff;border-radius:20px;padding:32px 24px;
      width:100%;max-width:420px;display:flex;flex-direction:column;gap:20px;
      box-shadow:0 8px 32px rgba(0,0,0,.2)}
    .emp-icon {font-size:52px;text-align:center}
    .emp-title{font-size:21px;font-weight:800;text-align:center}
    .emp-sub  {font-size:15px;color:var(--sub);text-align:center;line-height:1.6}
    #inp-emp  {text-align:center;font-size:34px;font-weight:800;letter-spacing:14px}
    .emp-note {font-size:13px;color:var(--sub);text-align:center}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       S2: ã‚«ãƒ¡ãƒ©
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-cam{background:#000}
    #video-el{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .cam-top{position:absolute;top:0;left:0;right:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      padding:52px 16px 12px;
      background:linear-gradient(to bottom,rgba(0,0,0,.7),transparent)}
    .emp-badge{display:flex;align-items:center;gap:6px;
      background:rgba(255,255,255,.18);backdrop-filter:blur(4px);
      border:1px solid rgba(255,255,255,.3);padding:6px 14px;border-radius:20px}
    .badge-lbl{font-size:12px;color:rgba(255,255,255,.8)}
    .badge-num{font-size:17px;font-weight:800;color:#fff;letter-spacing:3px}
    .cam-top-btns{display:flex;gap:8px}
    .cam-top-btn{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);
      color:#fff;padding:7px 14px;border-radius:20px;font-size:13px;
      font-weight:600;cursor:pointer}
    .cam-overlay{position:absolute;inset:0;z-index:5;display:flex;
      flex-direction:column;align-items:center;justify-content:center;pointer-events:none}
    .guide-box{width:min(84vw,440px);aspect-ratio:1.75;position:relative;
      border:2px dashed rgba(255,255,255,.55);border-radius:6px}
    .cor{position:absolute;width:22px;height:22px;border-color:#fff;border-style:solid;border-width:0}
    .cor.tl{top:-2px;left:-2px;border-top-width:3px;border-left-width:3px;border-radius:3px 0 0 0}
    .cor.tr{top:-2px;right:-2px;border-top-width:3px;border-right-width:3px;border-radius:0 3px 0 0}
    .cor.bl{bottom:-2px;left:-2px;border-bottom-width:3px;border-left-width:3px;border-radius:0 0 0 3px}
    .cor.br{bottom:-2px;right:-2px;border-bottom-width:3px;border-right-width:3px;border-radius:0 0 3px 0}
    .guide-txt{font-size:15px;font-weight:600;color:rgba(255,255,255,.9);
      text-shadow:0 1px 4px rgba(0,0,0,.6);margin-top:14px}
    .cam-bot{position:absolute;bottom:0;left:0;right:0;z-index:10;
      display:flex;flex-direction:column;align-items:center;
      padding:14px 20px 44px;gap:14px;
      background:linear-gradient(to top,rgba(0,0,0,.7),transparent)}
    .cam-tip{font-size:14px;color:rgba(255,255,255,.8);text-align:center}
    .shutter{width:76px;height:76px;border-radius:50%;
      border:4px solid rgba(255,255,255,.9);background:rgba(255,255,255,.15);
      cursor:pointer;position:relative;transition:transform .1s}
    .shutter:active{transform:scale(.92)}
    .shutter-dot{position:absolute;inset:6px;border-radius:50%;background:#fff;transition:background .15s}
    .shutter:disabled .shutter-dot{background:rgba(255,255,255,.35)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       S3: å‡¦ç†ä¸­
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-prog{background:#fff;align-items:center;justify-content:center;gap:22px}
    .prog-txt{font-size:19px;font-weight:700}
    .prog-sub{font-size:15px;color:var(--sub)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       S4: ç¢ºèªãƒ»ç·¨é›†
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-rev{background:var(--bg)}
    .rev-head{background:var(--blue);color:#fff;padding:52px 18px 18px}
    .rev-head h1{font-size:20px;font-weight:800}
    .rev-head p {font-size:14px;opacity:.85;margin-top:4px;line-height:1.5}
    .rev-body{flex:1;padding:14px 14px 0;display:flex;flex-direction:column;gap:12px}
    .thumb{width:100%;max-height:130px;object-fit:contain;border-radius:10px;background:#eee}
    .fields-card{background:#fff;border-radius:var(--radius);
      box-shadow:0 1px 4px rgba(0,0,0,.1);overflow:hidden}
    .f-row{display:flex;flex-direction:column;padding:11px 14px;
      border-bottom:1px solid var(--border)}
    .f-row:last-child{border-bottom:none}
    .f-row.filled .inp{border-color:#aacbff;background:#f0f6ff}
    .req{display:inline-flex;font-size:10px;font-weight:700;
      background:var(--red);color:#fff;padding:1px 5px;border-radius:3px;margin-left:4px}
    .memo-card{background:#fff;border-radius:var(--radius);padding:14px;
      box-shadow:0 1px 4px rgba(0,0,0,.1)}
    textarea.inp{resize:none;line-height:1.6}
    .rev-foot{padding:14px;display:flex;flex-direction:column;gap:10px;
      border-top:1px solid var(--border);background:var(--bg)}

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       S5: å®Œäº†
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #s-done{background:#fff;align-items:center;justify-content:center}
    .done-inner{display:flex;flex-direction:column;align-items:center;
      gap:16px;padding:40px 28px;max-width:420px;width:100%}
    .done-icon {font-size:80px;line-height:1}
    .done-title{font-size:24px;font-weight:800;text-align:center}
    .done-msg  {font-size:16px;color:var(--sub);text-align:center;line-height:1.7;white-space:pre-wrap}
    .done-inner .btn{margin-top:8px}

    #work-canvas{display:none}
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     S0: æ¥ç¶šè¨­å®š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-cfg" class="screen">
  <div class="cfg-card">
    <div style="font-size:48px;text-align:center">ğŸªª</div>
    <h1 class="cfg-title">ååˆºæ›¸ãå‡ºã—å›<br>æ¥ç¶šè¨­å®š</h1>
    <p class="cfg-sub">æœ€åˆã«1å›ã ã‘è¨­å®šã—ã¾ã™<br>æ¬¡å›ä»¥é™ã¯è‡ªå‹•ã§èµ·å‹•ã—ã¾ã™</p>

    <div class="cfg-field">
      <label class="lbl">GASã®URL</label>
      <div class="inp-wrap" style="padding-right:0">
        <input id="cfg-url" class="inp" type="url"
          placeholder="https://script.google.com/macros/s/â€¦/exec"
          autocomplete="off" spellcheck="false">
      </div>
      <p class="cfg-hint">
        <b>ç¢ºèªæ–¹æ³•ï¼š</b>GASã‚¨ãƒ‡ã‚£ã‚¿ â†’ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€â†’ã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã€<br>
        â†’ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã€ã®ä¸‹ã«è¡¨ç¤ºã•ã‚Œã‚‹URLã‚’è²¼ã‚Šä»˜ã‘<br>
        â€» <b>/exec</b> ã§çµ‚ã‚ã‚‹URLã‚’ä½¿ã£ã¦ãã ã•ã„
      </p>
    </div>

    <div class="cfg-field">
      <label class="lbl">åˆè¨€è‘‰ï¼ˆAPIã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆï¼‰</label>
      <div class="inp-wrap">
        <input id="cfg-secret" class="inp" type="password"
          placeholder="GASã«è¨­å®šã—ãŸåˆè¨€è‘‰" autocomplete="new-password">
        <button class="eye-btn" onclick="toggleEye('cfg-secret',this)">ğŸ‘</button>
      </div>
      <p class="cfg-hint">
        <b>ç¢ºèªæ–¹æ³•ï¼š</b>GASã®ã€Œã‚³ãƒ¼ãƒ‰.gsã€ã®<br>
        <b>CONFIG â†’ API_SECRET</b> ã«æ›¸ã„ãŸæ–‡å­—åˆ—
      </p>
    </div>

    <div id="cfg-banner" class="banner"></div>

    <button class="btn btn-gray btn-sm" onclick="Cfg.test()">
      ğŸ”— æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆä»»æ„ï¼‰
    </button>
    <hr class="cfg-divider">
    <button class="btn btn-blue" onclick="Cfg.save()">
      è¨­å®šã‚’ä¿å­˜ã—ã¦å§‹ã‚ã‚‹ â†’
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     S1: ç¤¾å“¡ç•ªå·
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-emp" class="screen">
  <div class="emp-card">
    <div class="emp-icon">ğŸ‘¤</div>
    <h1 class="emp-title">ç¤¾å“¡ç•ªå·ã®ç™»éŒ²</h1>
    <p class="emp-sub">ã‚ãªãŸã®4æ¡ã®ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>æ¬¡å›ä»¥é™ã¯è‡ªå‹•ã§å…¥åŠ›ã•ã‚Œã¾ã™</p>
    <div>
      <label class="lbl" for="inp-emp">4æ¡ã®ç¤¾å“¡ç•ªå·</label>
      <input id="inp-emp" class="inp" type="text" inputmode="numeric"
        maxlength="4" pattern="\d{4}" placeholder="ä¾‹ï¼š0007" autocomplete="off">
      <p id="emp-err" class="err"></p>
    </div>
    <button class="btn btn-blue" onclick="Emp.save()">æ’®å½±ã‚’å§‹ã‚ã‚‹ â†’</button>
    <p class="emp-note">â€» å¤‰æ›´ã¯ã‚«ãƒ¡ãƒ©ç”»é¢ã®ã€Œå¤‰æ›´ã€ã‹ã‚‰</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     S2: ã‚«ãƒ¡ãƒ©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-cam" class="screen">
  <video id="video-el" autoplay playsinline muted></video>

  <div class="cam-top">
    <div class="emp-badge">
      <span class="badge-lbl">ç¤¾å“¡ç•ªå·</span>
      <span id="cam-emp" class="badge-num">----</span>
    </div>
    <div class="cam-top-btns">
      <button class="cam-top-btn" onclick="Emp.change()">å¤‰æ›´</button>
      <button class="cam-top-btn" onclick="Cfg.open()">âš™ï¸</button>
    </div>
  </div>

  <div class="cam-overlay">
    <div class="guide-box">
      <div class="cor tl"></div><div class="cor tr"></div>
      <div class="cor bl"></div><div class="cor br"></div>
    </div>
    <p class="guide-txt">ååˆºã‚’æ ã®ä¸­ã«å…¥ã‚Œã¦ãã ã•ã„</p>
  </div>

  <div class="cam-bot">
    <p class="cam-tip">ğŸ’¡ æ˜ã‚‹ã„å ´æ‰€ã§æ‰‹ãƒ–ãƒ¬ãªãæ’®å½±ã—ã¦ãã ã•ã„</p>
    <button id="shutter" class="shutter" disabled onclick="Capture.shoot()">
      <span class="shutter-dot"></span>
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     S3: å‡¦ç†ä¸­
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-prog" class="screen">
  <div class="spinner"></div>
  <p id="prog-txt" class="prog-txt">èª­ã¿å–ã‚Šä¸­â€¦</p>
  <p class="prog-sub">ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     S4: ç¢ºèªãƒ»ç·¨é›†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-rev" class="screen">
  <div class="rev-head">
    <h1>å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„</h1>
    <p>è‡ªå‹•ã§èª­ã¿å–ã‚Šã¾ã—ãŸã€‚é•ã†å ´åˆã¯ã‚¿ãƒƒãƒ—ã—ã¦ä¿®æ­£ã§ãã¾ã™</p>
  </div>
  <div class="rev-body">
    <div id="rev-banner" class="banner"></div>
    <img id="thumb" class="thumb" alt="æ’®å½±ã—ãŸååˆº">
    <div id="fields-card" class="fields-card"></div>
    <div class="memo-card">
      <label class="lbl" for="memo">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
      <textarea id="memo" class="inp" rows="3" placeholder="å±•ç¤ºä¼šã§å–å¾—ã€ç´¹ä»‹ãªã©"></textarea>
    </div>
  </div>
  <div class="rev-foot">
    <button class="btn btn-green" onclick="Save.run()">âœ… ç™»éŒ²ã™ã‚‹</button>
    <button class="btn btn-outline" onclick="Capture.retake()">ğŸ“· æ’®ã‚Šç›´ã™</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     S5: å®Œäº†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-done" class="screen">
  <div class="done-inner">
    <div id="done-icon"  class="done-icon"></div>
    <h2 id="done-title" class="done-title"></h2>
    <p  id="done-msg"   class="done-msg"></p>
    <button class="btn btn-blue" onclick="Capture.next()">ç¶šã‘ã¦æ’®å½±ã™ã‚‹</button>
    <button id="retry-btn" class="btn btn-outline btn-sm"
      style="display:none" onclick="Save.run()">å†é€ä¿¡ã™ã‚‹</button>
  </div>
</div>

<canvas id="work-canvas"></canvas>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FIELDS = [
  {key:'companyName', label:'ä¼šç¤¾å',         req:true },
  {key:'department',  label:'éƒ¨ç½²å',         req:false},
  {key:'position',    label:'å½¹è·',           req:false},
  {key:'fullName',    label:'æ°å',           req:true },
  {key:'furigana',    label:'ãƒ•ãƒªã‚¬ãƒŠ',       req:false},
  {key:'officePhone', label:'é›»è©±ï¼ˆã‚ªãƒ•ã‚£ã‚¹ï¼‰',req:false},
  {key:'mobilePhone', label:'æºå¸¯é›»è©±ç•ªå·',   req:false},
  {key:'fax',         label:'FAX',            req:false},
  {key:'email',       label:'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', req:false},
  {key:'postalCode',  label:'éƒµä¾¿ç•ªå·',       req:false},
  {key:'address',     label:'ä½æ‰€',           req:false},
  {key:'website',     label:'Webã‚µã‚¤ãƒˆURL',   req:false},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ST = {empId:'', base64:null, reqId:'', ts:''};
let camStream = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç”»é¢ç®¡ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆè¨­å®šã®èª­ã¿æ›¸ãï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS = {
  get: k       => localStorage.getItem(k) || '',
  set: (k,v)   => localStorage.setItem(k, v),
  gasUrl:  ()  => LS.get('meishi_gas_url'),
  secret:  ()  => LS.get('meishi_secret'),
  empId:   ()  => LS.get('meishi_emp'),
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APIé€šä¿¡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Api = {
  async post(data) {
    const url = LS.gasUrl();
    if (!url) throw new Error('GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆâš™ï¸ã‹ã‚‰è¨­å®šã—ã¦ãã ã•ã„ï¼‰');

    let res;
    try {
      res = await fetch(url, {
        method:  'POST',
        headers: {'Content-Type':'application/json'},
        body:    JSON.stringify({...data, secret: LS.secret()}),
      });
    } catch (err) {
      // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ or CORSã‚¨ãƒ©ãƒ¼
      throw new Error(
        'GASã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n' +
        'ãƒ»URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„\n' +
        'ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®šãŒã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„\n' +
        'ï¼ˆæŠ€è¡“è©³ç´°: ' + err.message + 'ï¼‰'
      );
    }

    if (!res.ok) throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼ˆHTTP ' + res.status + 'ï¼‰');

    let json;
    try { json = await res.json(); }
    catch(_) { throw new Error('GASã‹ã‚‰ã®è¿”ç­”ãŒèª­ã‚ã¾ã›ã‚“ã§ã—ãŸ'); }

    return json;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S0: æ¥ç¶šè¨­å®š
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Cfg = {
  open() {
    // ç¾åœ¨å€¤ã‚’è¡¨ç¤º
    document.getElementById('cfg-url').value    = LS.gasUrl();
    document.getElementById('cfg-secret').value = LS.secret();
    _hideBanner('cfg-banner');
    Camera.stop();
    show('s-cfg');
  },

  async test() {
    const url    = document.getElementById('cfg-url').value.trim();
    const secret = document.getElementById('cfg-secret').value.trim();

    if (!url)    return _showBanner('cfg-banner','err','URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!secret) return _showBanner('cfg-banner','err','åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!url.includes('script.google.com'))
      return _showBanner('cfg-banner','err','URLãŒGASã®URLã§ã¯ãªã„ã‚ˆã†ã§ã™\nhttps://script.google.com/macros/s/â€¦/exec ã®å½¢å¼ã‹ç¢ºèªã—ã¦ãã ã•ã„');

    _showBanner('cfg-banner','warn','æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­â€¦');

    try {
      // action:'test' ã‚’æŠ•ã’ã‚‹ â†’ GASã¯ E003 ã‚’è¿”ã™ï¼ˆ= é€šä¿¡ã¯ã§ãã¦ã„ã‚‹ï¼‰
      const res = await fetch(url, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({action:'test', secret}),
      });
      const json = await res.json();

      if (json.code === 'E040') {
        _showBanner('cfg-banner','err',
          'âŒ åˆè¨€è‘‰ãŒé•ã„ã¾ã™\nGASã® CONFIG â†’ API_SECRET ã¨åŒã˜å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      } else {
        // E003ï¼ˆä¸æ˜ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰= é€šä¿¡OKãƒ»èªè¨¼OK
        _showBanner('cfg-banner','ok','âœ… æ¥ç¶šæˆåŠŸï¼GASã¨é€šä¿¡ã§ãã¦ã„ã¾ã™');
      }
    } catch(err) {
      _showBanner('cfg-banner','err',
        'âŒ æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ\n\nè€ƒãˆã‚‰ã‚Œã‚‹åŸå› :\n' +
        'â‘  URLãŒé–“é•ã£ã¦ã„ã‚‹\n' +
        'â‘¡ GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã€Œã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ãŒ\n   ã€Œå…¨å“¡ã€ã«ãªã£ã¦ã„ãªã„\n\n' +
        'æŠ€è¡“è©³ç´°: ' + err.message);
    }
  },

  save() {
    const url    = document.getElementById('cfg-url').value.trim();
    const secret = document.getElementById('cfg-secret').value.trim();

    if (!url)    return _showBanner('cfg-banner','err','URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!secret) return _showBanner('cfg-banner','err','åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!url.startsWith('https://script.google.com'))
      return _showBanner('cfg-banner','err',
        'URLãŒæ­£ã—ããªã„ã‚ˆã†ã§ã™\nhttps://script.google.com/â€¦ ã§å§‹ã¾ã‚‹URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!url.endsWith('/exec'))
      return _showBanner('cfg-banner','err',
        'URLã¯ /exec ã§çµ‚ã‚ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™\nã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç®¡ç†ã€ã§è¡¨ç¤ºã•ã‚Œã‚‹URLã‚’ã”ç¢ºèªãã ã•ã„');

    LS.set('meishi_gas_url', url);
    LS.set('meishi_secret',  secret);

    // æ¬¡ã®ç”»é¢ã¸
    const empId = LS.empId();
    if (empId && /^\d{4}$/.test(empId)) {
      ST.empId = empId;
      _refreshBadge();
      Camera.open();
    } else {
      show('s-emp');
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S1: ç¤¾å“¡ç•ªå·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Emp = {
  save() {
    const val = document.getElementById('inp-emp').value.trim();
    const err = document.getElementById('emp-err');
    if (!/^\d{4}$/.test(val)) {
      err.textContent = 'âŒ 0ã€œ9ã®4æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š0007ï¼‰';
      err.classList.add('show'); return;
    }
    err.classList.remove('show');
    ST.empId = val;
    LS.set('meishi_emp', val);
    _refreshBadge();
    Camera.open();
  },
  change() { Camera.stop(); document.getElementById('inp-emp').value = ST.empId; show('s-emp'); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S2: ã‚«ãƒ¡ãƒ©
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Camera = {
  async open() {
    show('s-cam');
    _refreshBadge();
    await this.start();
  },
  async start() {
    try {
      if (camStream) this.stop();
      camStream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode:{ideal:'environment'}, width:{ideal:1920}}, audio:false,
      });
      const v = document.getElementById('video-el');
      v.srcObject = camStream;
      v.onloadedmetadata = () => { document.getElementById('shutter').disabled = false; };
    } catch(err) {
      Result.show('error','ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼',
        err.name === 'NotAllowedError'
          ? 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\niPhoneã®ã€Œè¨­å®šã€â†’ã€ŒSafariã€â†’ã€Œã‚«ãƒ¡ãƒ©ã€\nã‚’ã€Œè¨±å¯ã€ã«å¤‰æ›´ã—ã¦ãã ã•ã„'
          : 'ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„\nï¼ˆ' + err.message + 'ï¼‰');
    }
  },
  stop() {
    if (camStream) { camStream.getTracks().forEach(t => t.stop()); camStream = null; }
    const s = document.getElementById('shutter');
    if (s) s.disabled = true;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ’®å½± â†’ OCR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Capture = {
  async shoot() {
    const video  = document.getElementById('video-el');
    const canvas = document.getElementById('work-canvas');
    if (!video.videoWidth) return;

    // ãƒªã‚µã‚¤ã‚ºã—ã¦æ’®å½±ï¼ˆå†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¯ä¿å­˜ã—ãªã„ï¼‰
    const MAX = 1200, r = Math.min(1, MAX / video.videoWidth);
    canvas.width  = Math.round(video.videoWidth  * r);
    canvas.height = Math.round(video.videoHeight * r);
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    document.getElementById('thumb').src = canvas.toDataURL('image/jpeg', 0.85);
    ST.base64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
    ST.ts     = new Date().toISOString();
    ST.reqId  = ST.empId + '_' + ST.ts.replace(/\D/g,'').slice(0,14);

    Camera.stop();

    // OCRé–‹å§‹
    _setProgress('ååˆºã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦');
    show('s-prog');

    let extracted = {};
    let warnMsg   = '';

    try {
      const res = await Api.post({
        action:'extract', imageBase64:ST.base64,
        employeeId:ST.empId, timestamp:ST.ts,
      });

      if (res.ok) {
        extracted = res.extracted || {};
        const filledCount = Object.values(extracted).filter(v => v && v.trim()).length;
        if (filledCount === 0) {
          warnMsg = 'âš ï¸ æ–‡å­—ã‚’èª­ã¿å–ã‚Šã¾ã—ãŸãŒæƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ\né …ç›®ã‚’æ‰‹å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™';
        }
      } else {
        // GASã‹ã‚‰ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ãŸ
        warnMsg = 'âš ï¸ èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ï¼ˆ' + (res.code||'?') + 'ï¼‰\n' + (res.message||'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼') + '\n\né …ç›®ã‚’æ‰‹å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™';
      }
    } catch(err) {
      // é€šä¿¡ã‚¨ãƒ©ãƒ¼
      warnMsg = 'âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼\n' + err.message + '\n\né …ç›®ã‚’æ‰‹å…¥åŠ›ã—ã¦ç™»éŒ²ã§ãã¾ã™';
    }

    Review.build(extracted, warnMsg);
    show('s-rev');
  },

  retake() { Camera.open(); },
  next()   { Camera.open(); },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S4: ç¢ºèªãƒ•ã‚©ãƒ¼ãƒ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Review = {
  build(data, warnMsg) {
    // ãƒãƒŠãƒ¼è¡¨ç¤º
    const banner = document.getElementById('rev-banner');
    if (warnMsg) { banner.textContent = warnMsg; banner.className = 'banner warn show'; }
    else         { banner.className = 'banner'; }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
    document.getElementById('fields-card').innerHTML = FIELDS.map(f => {
      const val  = (data[f.key] || '').replace(/"/g,'&quot;');
      const req  = f.req ? '<span class="req">å¿…é ˆ</span>' : '';
      const fill = val ? ' filled' : '';
      return `<div class="f-row${fill}">
        <label class="lbl" for="f-${f.key}">${f.label}${req}</label>
        <input id="f-${f.key}" class="inp" type="text" value="${val}"
          placeholder="ï¼ˆç©ºæ¬„ã§ã‚‚ç™»éŒ²ã§ãã¾ã™ï¼‰">
      </div>`;
    }).join('');
    document.getElementById('memo').value = '';
  },
  getData() {
    const d = {};
    FIELDS.forEach(f => { d[f.key] = (document.getElementById('f-'+f.key)||{}).value||''; });
    return d;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç™»éŒ²ï¼ˆSheetsä¿å­˜ï¼‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Save = {
  async run() {
    _setProgress('ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ç™»éŒ²ä¸­â€¦');
    show('s-prog');

    try {
      const res = await Api.post({
        action:'save', data:Review.getData(),
        employeeId:ST.empId, timestamp:ST.ts,
        requestId:ST.reqId,  memo:document.getElementById('memo').value,
      });

      if (res.status === 'DUPLICATE') {
        Result.show('info','ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™','ã“ã®ååˆºã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™\nï¼ˆé‡è¤‡é€ä¿¡ã‚’é˜²æ­¢ã—ã¾ã—ãŸï¼‰');
      } else if (res.ok) {
        Result.show(
          res.status === 'SUCCESS' ? 'success' : 'warn',
          res.status === 'SUCCESS' ? 'ç™»éŒ²å®Œäº†ï¼' : 'è¦ç¢ºèªã§ä¿å­˜ã—ã¾ã—ãŸ',
          res.message || ''
        );
      } else {
        throw new Error(res.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ¼ãƒ‰: ' + (res.code||'?') + 'ï¼‰');
      }
    } catch(err) {
      Result.show('error','ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', err.message, true);
    }
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S5: å®Œäº†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const Result = {
  show(type, title, msg, showRetry=false) {
    const icons = {success:'âœ…', warn:'âš ï¸', error:'âŒ', info:'â„¹ï¸'};
    document.getElementById('done-icon').textContent  = icons[type]||'â“';
    document.getElementById('done-title').textContent = title;
    document.getElementById('done-msg').textContent   = msg;
    document.getElementById('retry-btn').style.display = showRetry ? 'flex' : 'none';
    show('s-done');
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å†…éƒ¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function _refreshBadge() {
  const el = document.getElementById('cam-emp');
  if (el) el.textContent = ST.empId || '----';
}
function _setProgress(txt) {
  const el = document.getElementById('prog-txt');
  if (el) el.textContent = txt;
}
function _showBanner(id, type, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className   = 'banner ' + type + ' show';
}
function _hideBanner(id) {
  const el = document.getElementById(id);
  if (el) el.className = 'banner';
}
function toggleEye(inputId, btn) {
  const el  = document.getElementById(inputId);
  const vis = el.type === 'password';
  el.type   = vis ? 'text' : 'password';
  btn.textContent = vis ? 'ğŸ™ˆ' : 'ğŸ‘';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// èµ·å‹•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', () => {
  const gasUrl = LS.gasUrl();
  const secret = LS.secret();
  const empId  = LS.empId();

  // GAS URLãƒ»åˆè¨€è‘‰ãŒæœªè¨­å®š â†’ è¨­å®šç”»é¢ã¸
  if (!gasUrl || !secret) { show('s-cfg'); return; }

  // ç¤¾å“¡ç•ªå·ãŒæœªè¨­å®š â†’ ç¤¾å“¡ç•ªå·å…¥åŠ›ã¸
  if (!empId || !/^\d{4}$/.test(empId)) { show('s-emp'); return; }

  // ã™ã¹ã¦è¨­å®šæ¸ˆã¿ â†’ ã‚«ãƒ¡ãƒ©ã¸
  ST.empId = empId;
  _refreshBadge();
  Camera.open();
});
</script>
</body>
</html>
